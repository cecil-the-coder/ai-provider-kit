{"id":"workspace-01c","title":"Tests: pkg/http (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:57:42.471620556Z","updated_at":"2025-11-29T10:17:27.993002436Z","closed_at":"2025-11-29T10:17:27.993002436Z"}
{"id":"workspace-07e","title":"Fix G306 file permissions in fileutils test","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:16:16.214644807Z","updated_at":"2025-11-29T11:18:04.134256582Z","closed_at":"2025-11-29T11:18:04.134256582Z"}
{"id":"workspace-07o","title":"Tests: pkg/backendtypes (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:56:18.9800608Z","updated_at":"2025-11-29T10:05:55.891516196Z","closed_at":"2025-11-29T10:05:55.891516196Z"}
{"id":"workspace-0ha","title":"APK 3.2: Add Metrics Handler","description":"**Task 3.2: Add Metrics Handler**\n\n**Priority:** P1 - High\n**Estimated Effort:** 6 hours\n\n**Features:**\n- Provider metrics endpoint\n- System metrics endpoint\n- Racing performance metrics endpoint\n\n**Acceptance Criteria:**\n- [ ] Provider metrics endpoint\n- [ ] System metrics endpoint\n- [ ] Racing performance metrics endpoint\n\n**Context:**\nThis task is part of Phase 3: Integration (Week 5-6) for the AI-PROVIDER-KIT component. It focuses on adding metrics collection and reporting capabilities to monitor provider performance, system health, and racing algorithm effectiveness.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:46.23127434Z","updated_at":"2025-11-29T02:38:25.592582201Z","closed_at":"2025-11-29T02:38:25.592582201Z","dependencies":[{"issue_id":"workspace-0ha","depends_on_id":"workspace-sqx","type":"blocks","created_at":"2025-11-29T02:00:40.341629509Z","created_by":"daemon"}]}
{"id":"workspace-0mw","title":"Fix S1024 use time.Until in keymanager test","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:16:16.241449187Z","updated_at":"2025-11-29T11:18:04.14767764Z","closed_at":"2025-11-29T11:18:04.14767764Z"}
{"id":"workspace-0vd","title":"Fix G602 slice bounds check in racing provider","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:16:16.161901545Z","updated_at":"2025-11-29T11:18:04.106040349Z","closed_at":"2025-11-29T11:18:04.106040349Z"}
{"id":"workspace-0yx","title":"Fix duplicate code in security_test.go","description":"golangci-lint dupl: pkg/auth/security_test.go:132-163 lines are duplicate of lines 317-348. Refactor to eliminate duplication.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T10:49:46.702496922Z","updated_at":"2025-11-29T10:58:15.633616477Z","closed_at":"2025-11-29T10:58:15.633616477Z"}
{"id":"workspace-1id","title":"Reduce cyclomatic complexity in StreamHandler","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:32:03.104988241Z","updated_at":"2025-11-29T11:35:55.014018069Z","closed_at":"2025-11-29T11:35:55.014018069Z"}
{"id":"workspace-1nh","title":"APK 2.2: Implement Provider Management Handler","description":"#### Task 2.2: Implement Provider Management Handler\n**Priority:** P0 - Blocking\n**Estimated Effort:** 8 hours\n\n**File:** `pkg/backend/handlers/providers.go`\n\n**Features:**\n- List providers\n- Get provider details\n- Update provider configuration\n- Provider health checking\n- Provider testing endpoint\n- Virtual provider support\n\n**Acceptance Criteria:**\n- [ ] List, Get, Update providers\n- [ ] Provider health checking\n- [ ] Provider testing endpoint\n- [ ] Virtual provider support\n- [ ] Unit tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:41.694171306Z","updated_at":"2025-11-29T02:24:45.67181681Z","closed_at":"2025-11-29T02:24:45.67181681Z","dependencies":[{"issue_id":"workspace-1nh","depends_on_id":"workspace-uud","type":"blocks","created_at":"2025-11-29T02:00:39.238774367Z","created_by":"daemon"}]}
{"id":"workspace-1x4","title":"APK 2.4: Implement Health and Status Handlers","description":"#### Task 2.4: Implement Health and Status Handlers\n**Priority:** P1 - High\n**Estimated Effort:** 4 hours\n\n**File:** `pkg/backend/handlers/health.go`\n\n**Acceptance Criteria:**\n- [ ] Status endpoint\n- [ ] Health endpoint with provider health\n- [ ] Version information\n- [ ] Unit tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:43.570379278Z","updated_at":"2025-11-29T02:24:45.692145006Z","closed_at":"2025-11-29T02:24:45.692145006Z","dependencies":[{"issue_id":"workspace-1x4","depends_on_id":"workspace-uud","type":"blocks","created_at":"2025-11-29T02:00:39.2596464Z","created_by":"daemon"}]}
{"id":"workspace-225","title":"Support per-request extension configuration","description":"## Summary\nAllow extensions to be configured or disabled on a per-request basis via request metadata.\n\n## Motivation\nCurrently all extensions apply uniformly to all requests. Some use cases need:\n- Disable caching for specific requests\n- Change logging verbosity per request\n- Skip certain processing for internal/admin requests\n- A/B testing with different extension configurations\n\n## Proposed API\n```go\n// In GenerateRequest.Metadata\nreq.Metadata[\"extensions\"] = map[string]interface{}{\n    \"caching\": map[string]interface{}{\n        \"enabled\": false,\n    },\n    \"logging\": map[string]interface{}{\n        \"level\": \"debug\",\n    },\n    \"rate-limiter\": map[string]interface{}{\n        \"enabled\": false,  // Skip rate limiting for admin requests\n    },\n}\n```\n\n## Implementation Notes\n- Extensions receive their config subset in hook calls\n- Add helper method: `GetExtensionConfig(ctx, extensionName) map[string]interface{}`\n- Extensions opt-in to per-request config (backward compatible)\n- Document security implications (client shouldn't bypass security extensions)","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T12:20:12.874962359Z","updated_at":"2025-11-29T12:26:07.6374065Z","closed_at":"2025-11-29T12:26:07.6374065Z"}
{"id":"workspace-2fy","title":"APK 1.8: Create Core Middleware","description":"#### Task 1.8: Create Core Middleware\n**Priority:** P0 - Blocking\n**Estimated Effort:** 4 hours\n\n**Files to create:**\n- [ ] `pkg/backend/middleware/requestid.go` - Request ID generation\n- [ ] `pkg/backend/middleware/cors.go` - CORS handling\n- [ ] `pkg/backend/middleware/logging.go` - Request logging\n- [ ] `pkg/backend/middleware/recovery.go` - Panic recovery\n- [ ] `pkg/backend/middleware/auth.go` - Authentication\n\n**Acceptance Criteria:**\n- [ ] All middleware implemented and tested\n- [ ] Middleware follows standard http.Handler pattern\n- [ ] Configuration-driven behavior\n- [ ] Unit tests for each middleware","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:22.707956383Z","updated_at":"2025-11-29T02:16:12.7768934Z","closed_at":"2025-11-29T02:16:12.7768934Z","dependencies":[{"issue_id":"workspace-2fy","depends_on_id":"workspace-30d","type":"blocks","created_at":"2025-11-29T02:00:38.086448065Z","created_by":"daemon"}]}
{"id":"workspace-2gi","title":"Remove 'expert programmer' fallback system prompt from Anthropic provider","description":"## Summary\n\nThe Anthropic provider adds a hardcoded \"expert programmer\" system prompt as a fallback when no system messages are provided. This is problematic for general-purpose API proxies and applications that aren't code-focused.\n\n## Current Behavior\n\nIn `pkg/providers/anthropic/anthropic.go` lines 566-569:\n\n```go\nif len(systemPrompts) \u003e 0 {\n    // Uses provided system prompts ✓\n    fullSystemPrompt = claudeCodePrompt + \"\\n\\n\" + systemPrompts[0]\n} else {\n    // PROBLEM: Adds code-generation prompt when no system message provided\n    codeGenerationPrompt := fmt.Sprintf(\"You are an expert programmer. Generate ONLY clean, functional code in %s with no explanations...\")\n    fullSystemPrompt = claudeCodePrompt + \"\\n\\n\" + codeGenerationPrompt\n}\n```\n\n## The Problem\n\nWhen a user sends a simple request like:\n```json\n{\"model\": \"claude-3-5-sonnet\", \"messages\": [{\"role\": \"user\", \"content\": \"What is 2+2?\"}]}\n```\n\nThe model receives:\n```\nSystem: You are Claude Code, Anthropic's official CLI for Claude.\n\nYou are an expert programmer. Generate ONLY clean, functional code...\n```\n\nThis causes the model to either:\n- Return empty responses (trying to generate \"code\" for non-code questions)\n- Behave inappropriately for general chat use cases\n\n## What Should NOT Change\n\nThe `claudeCodePrompt` (\"You are Claude Code, Anthropic's official CLI for Claude.\") is required for Anthropic OAuth and should remain.\n\n## Requested Fix\n\nWhen no system messages are provided, only use `claudeCodePrompt` without the code-generation fallback.\n\n**Additionally**: Check if the provided system prompt already contains the Claude Code identifier to avoid duplication (e.g., when Claude Code itself is the client):\n\n```go\n// Check if Claude Code prompt is already present in user's system prompt\nclaudeCodeAlreadyPresent := false\nfor _, sp := range systemPrompts {\n    if strings.Contains(sp, \"Claude Code\") || strings.Contains(sp, \"Anthropic's official CLI\") {\n        claudeCodeAlreadyPresent = true\n        break\n    }\n}\n\nif len(systemPrompts) \u003e 0 {\n    if claudeCodeAlreadyPresent {\n        // User already has Claude Code context, don't duplicate\n        fullSystemPrompt = strings.Join(systemPrompts, \"\\n\\n\")\n    } else {\n        // Prepend Claude Code prompt to user's system prompts\n        fullSystemPrompt = claudeCodePrompt + \"\\n\\n\" + strings.Join(systemPrompts, \"\\n\\n\")\n    }\n} else {\n    // No user system prompts, just use the required Claude Code prompt\n    fullSystemPrompt = claudeCodePrompt\n}\n```\n\n## Alternative: Config Option\n\nIf backwards compatibility is needed, add a config option:\n\n```go\ntype AnthropicConfig struct {\n    // ... existing fields\n    DisableCodePromptFallback bool `json:\"disable_code_prompt_fallback,omitempty\"`\n}\n```\n\n## Impact\n\nThis affects any application using ai-provider-kit's Anthropic provider for non-code-generation use cases, including:\n- General-purpose LLM proxies\n- Chat applications\n- Q\u0026A systems\n- Any application where users don't always provide system prompts\n- **Claude Code as a client** (would receive duplicate Claude Code prompts)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T15:01:43.165731976Z","updated_at":"2025-11-29T15:06:26.26430594Z","closed_at":"2025-11-29T15:06:26.26430594Z"}
{"id":"workspace-2ix","title":"APK 1.5: Implement Fallback Virtual Provider","description":"#### Task 1.5: Implement Fallback Virtual Provider\n**Priority:** P0 - Blocking\n**Estimated Effort:** 4 hours\n\n**File:** `pkg/providers/virtual/fallback/provider.go`\n\n```go\npackage fallback\n\nimport (\n    \"context\"\n    \"fmt\"\n\n    \"github.com/anthropics/ai-provider-kit/pkg/types\"\n)\n\n// FallbackProvider tries providers in order until one succeeds\ntype FallbackProvider struct {\n    name      string\n    providers []types.Provider\n    config    *Config\n}\n\ntype Config struct {\n    ProviderNames []string `yaml:\"providers\"`\n    MaxRetries    int      `yaml:\"max_retries\"`\n}\n\nfunc NewFallbackProvider(name string, config *Config) *FallbackProvider {\n    return \u0026FallbackProvider{\n        name:   name,\n        config: config,\n    }\n}\n\nfunc (f *FallbackProvider) SetProviders(providers []types.Provider) {\n    f.providers = providers\n}\n\nfunc (f *FallbackProvider) Name() string              { return f.name }\nfunc (f *FallbackProvider) Type() types.ProviderType { return \"fallback\" }\nfunc (f *FallbackProvider) Description() string      { return \"Tries providers in order until one succeeds\" }\n\nfunc (f *FallbackProvider) GenerateChatCompletion(ctx context.Context, opts types.GenerateOptions) (types.ChatCompletionStream, error) {\n    var lastErr error\n\n    for i, provider := range f.providers {\n        chatProvider, ok := provider.(types.ChatProvider)\n        if !ok {\n            continue\n        }\n\n        stream, err := chatProvider.GenerateChatCompletion(ctx, opts)\n        if err == nil {\n            return \u0026fallbackStream{\n                inner:         stream,\n                providerName:  provider.Name(),\n                providerIndex: i,\n            }, nil\n        }\n\n        lastErr = err\n    }\n\n    if lastErr != nil {\n        return nil, fmt.Errorf(\"all providers failed, last error: %w\", lastErr)\n    }\n    return nil, fmt.Errorf(\"no providers available\")\n}\n\ntype fallbackStream struct {\n    inner         types.ChatCompletionStream\n    providerName  string\n    providerIndex int\n}\n\nfunc (s *fallbackStream) Next() (types.ChatCompletionChunk, error) {\n    chunk, err := s.inner.Next()\n    if chunk.Metadata == nil {\n        chunk.Metadata = make(map[string]interface{})\n    }\n    chunk.Metadata[\"fallback_provider\"] = s.providerName\n    chunk.Metadata[\"fallback_index\"] = s.providerIndex\n    return chunk, err\n}\n\nfunc (s *fallbackStream) Close() error {\n    return s.inner.Close()\n}\n```\n\n**Acceptance Criteria:**\n- [ ] Fallback provider implements types.Provider\n- [ ] Tries providers in order\n- [ ] Returns first successful response\n- [ ] Proper error aggregation\n- [ ] Unit tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:18.434416673Z","updated_at":"2025-11-29T02:16:10.157768361Z","closed_at":"2025-11-29T02:16:10.157768361Z","dependencies":[{"issue_id":"workspace-2ix","depends_on_id":"workspace-30d","type":"blocks","created_at":"2025-11-29T02:00:38.055851386Z","created_by":"daemon"}]}
{"id":"workspace-2qs","title":"Document multimodal content support","description":"## Overview\n\nAdd documentation for multimodal content support in ai-provider-kit.\n\n## Documentation Sections\n\n### 1. Multimodal Content Overview\n- ContentPart and MediaSource types\n- Supported content types by provider\n- Design philosophy (primitives, not patterns)\n\n### 2. Usage Examples\n\n```go\n// Simple text message\nmsg := types.ChatMessage{\n    Role:    \"user\",\n    Content: \"Hello, world!\",\n}\n\n// Image with text\nmsg := types.ChatMessage{\n    Role: \"user\",\n    Content: []types.ContentPart{\n        {Type: \"text\", Text: \"What's in this image?\"},\n        {Type: \"image\", Source: \u0026types.MediaSource{\n            Type:      \"base64\",\n            MediaType: \"image/png\",\n            Data:      base64Data,\n        }},\n    },\n}\n\n// Image from URL\nmsg := types.ChatMessage{\n    Role: \"user\", \n    Content: []types.ContentPart{\n        {Type: \"text\", Text: \"Describe this image\"},\n        {Type: \"image\", Source: \u0026types.MediaSource{\n            Type:      \"url\",\n            MediaType: \"image/jpeg\",\n            URL:       \"https://example.com/image.jpg\",\n        }},\n    },\n}\n```\n\n### 3. Helper Methods\n- GetContentParts()\n- GetTextContent()\n- HasImages()\n- HasMedia()\n- AddContentPart()\n\n### 4. Provider-Specific Notes\n- Anthropic: Native support, closest to our format\n- OpenAI: Uses data URLs for base64 images\n- Gemini: Uses inlineData/fileData structures\n\n### 5. Advanced Patterns\n- Building image caching layers (like claude-code-router)\n- Agent-based image delegation\n- Preprocessing pipelines\n\n## Location\n\n- Update README.md with multimodal section\n- Add examples/multimodal/ directory with working examples","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T16:05:42.372270298Z","updated_at":"2025-11-30T16:05:42.372270298Z","dependencies":[{"issue_id":"workspace-2qs","depends_on_id":"workspace-vsp","type":"blocks","created_at":"2025-11-30T16:05:42.37574115Z","created_by":"daemon"}]}
{"id":"workspace-2ru","title":"CleanCodeResponse should not be applied unconditionally to all Anthropic responses","description":"## Problem\n\nThe Anthropic provider calls `CleanCodeResponse()` on all responses, which:\n1. Strips markdown code blocks\n2. Removes short first lines (like \"4\", \"yes\", \"no\") thinking they're language identifiers\n\n## Impact\n\nShort legitimate responses get stripped, returning empty content.\n\nExample: A user asks \"What is 2+2?\" and the model responds \"4\" - this gets stripped because CleanCodeResponse thinks \"4\" is a language identifier line.\n\n## Root Cause\n\nai-provider-kit assumes all users are building code-generation tools. This logic belongs in the client application (e.g., VelocityCode) that actually knows the context of the request.\n\n## Current Location\n\nThe `CleanCodeResponse` function is in `pkg/providers/common/cleanup.go` and is called from the Anthropic provider's response handling.\n\n## Fix Options\n\n1. **Remove it entirely** (recommended) - Let clients handle response formatting\n   - ai-provider-kit should be a neutral API layer\n   - Clients like VelocityCode can implement their own cleanup logic\n\n2. **Make it opt-in via config**\n   ```go\n   type ProviderConfig struct {\n       // ... existing fields\n       CleanCodeResponses bool `json:\"clean_code_responses,omitempty\"`\n   }\n   ```\n\n3. **Only apply when request indicates code generation**\n   - Check for code-related keywords in the prompt\n   - Check for output file extension in options\n   - This is fragile and still makes assumptions\n\n## Recommendation\n\nOption 1 (remove entirely) is the cleanest solution. The ai-provider-kit library should:\n- Pass through responses as-is from the API\n- Not make assumptions about what clients are building\n- Let higher-level applications (VelocityCode, etc.) handle domain-specific formatting\n\n## Files to Modify\n\n- `pkg/providers/anthropic/anthropic.go` - Remove CleanCodeResponse call\n- `pkg/providers/gemini/gemini.go` - Remove CleanCodeResponse call (if present)\n- Consider deprecating `pkg/providers/common/cleanup.go` or marking it as a utility for clients to use optionally","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T15:22:44.261982733Z","updated_at":"2025-11-29T15:30:52.058132028Z","closed_at":"2025-11-29T15:30:52.058132028Z"}
{"id":"workspace-2tl","title":"Fix final lint issues batch","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:41:00.876372486Z","updated_at":"2025-11-29T11:47:13.884527995Z","closed_at":"2025-11-29T11:47:13.884527995Z"}
{"id":"workspace-2xd","title":"APK 2.3: Implement Generation Handler","description":"#### Task 2.3: Implement Generation Handler\n**Priority:** P0 - Blocking\n**Estimated Effort:** 8 hours\n\n**File:** `pkg/backend/handlers/generate.go`\n\n**Acceptance Criteria:**\n- [ ] Generate endpoint with extension hooks\n- [ ] Provider selection (including virtual providers)\n- [ ] Error handling with extension notification\n- [ ] Unit tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:42.494615461Z","updated_at":"2025-11-29T02:24:45.682414056Z","closed_at":"2025-11-29T02:24:45.682414056Z","dependencies":[{"issue_id":"workspace-2xd","depends_on_id":"workspace-uud","type":"blocks","created_at":"2025-11-29T02:00:39.248923053Z","created_by":"daemon"}]}
{"id":"workspace-30d","title":"APK 1.1: Create Package Structure","description":"### Task 1.1: Create Package Structure\n**Priority:** P0 - Blocking\n**Estimated Effort:** 2 hours\n\nCreate the new package structure:\n\n```bash\nmkdir -p pkg/backend/{handlers,middleware,extensions}\nmkdir -p pkg/backendtypes\nmkdir -p pkg/providers/virtual/{racing,fallback,loadbalance}\n```\n\n**Files to create:**\n- [ ] `pkg/backend/doc.go` - Package documentation\n- [ ] `pkg/backendtypes/doc.go` - Package documentation\n- [ ] `pkg/providers/virtual/doc.go` - Virtual providers documentation\n\n**Acceptance Criteria:**\n- Package structure created\n- Documentation explains purpose of each package","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:14.654679625Z","updated_at":"2025-11-29T02:07:16.091857063Z","closed_at":"2025-11-29T02:07:16.091857063Z"}
{"id":"workspace-30w","title":"APK 3.4: Register Virtual Providers in Factory","description":"**Task 3.4: Register Virtual Providers in Factory**\n\n**Priority:** P0 - Blocking\n**Estimated Effort:** 4 hours\n\nUpdate factory to register virtual providers:\n\n```go\nfunc RegisterDefaultProviders(f ProviderFactory) {\n    // Real providers\n    f.RegisterProvider(\"openai\", openai.NewProvider)\n    f.RegisterProvider(\"anthropic\", anthropic.NewProvider)\n    // ... other providers\n\n    // Virtual providers\n    f.RegisterProvider(\"racing\", racing.NewRacingProvider)\n    f.RegisterProvider(\"fallback\", fallback.NewFallbackProvider)\n    f.RegisterProvider(\"loadbalance\", loadbalance.NewLoadBalanceProvider)\n}\n```\n\n**Features:**\n- Virtual providers registered in factory\n- Configuration parsing for virtual providers\n- Dependency resolution (racing depends on other providers)\n\n**Acceptance Criteria:**\n- [ ] Virtual providers registered in factory\n- [ ] Virtual provider configuration parsing\n- [ ] Provider dependency resolution (racing depends on other providers)\n- [ ] Unit tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:58.041033403Z","updated_at":"2025-11-29T02:21:29.919453992Z","closed_at":"2025-11-29T02:21:29.919453992Z","dependencies":[{"issue_id":"workspace-30w","depends_on_id":"workspace-co0","type":"blocks","created_at":"2025-11-29T02:00:40.36448143Z","created_by":"daemon"},{"issue_id":"workspace-30w","depends_on_id":"workspace-2ix","type":"blocks","created_at":"2025-11-29T02:00:40.374955392Z","created_by":"daemon"},{"issue_id":"workspace-30w","depends_on_id":"workspace-xzt","type":"blocks","created_at":"2025-11-29T02:00:40.386779749Z","created_by":"daemon"}]}
{"id":"workspace-37p","title":"Tests: pkg/providers/common (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:57:45.520603353Z","updated_at":"2025-11-29T10:35:45.420036614Z","closed_at":"2025-11-29T10:35:45.420036614Z"}
{"id":"workspace-3i4","title":"Update ChatMessage to support multimodal content","description":"## Overview\n\nUpdate ChatMessage to support both simple string content and multimodal content parts.\n\n## Changes to ChatMessage\n\n```go\ntype ChatMessage struct {\n    Role    string      `json:\"role\"`\n    Content interface{} `json:\"content\"` // string OR []ContentPart\n    \n    // ... existing fields (ToolCalls, ToolCallID, etc.)\n}\n```\n\n## Helper Methods to Add\n\n```go\n// GetContentParts returns content as []ContentPart\n// If Content is a string, returns [{Type: \"text\", Text: content}]\nfunc (m *ChatMessage) GetContentParts() []ContentPart\n\n// GetTextContent returns concatenated text from all text parts\nfunc (m *ChatMessage) GetTextContent() string\n\n// HasImages returns true if any content part is an image\nfunc (m *ChatMessage) HasImages() bool\n\n// HasMedia returns true if any content part has media (image, document, audio)\nfunc (m *ChatMessage) HasMedia() bool\n\n// SetTextContent sets Content to a simple string\nfunc (m *ChatMessage) SetTextContent(text string)\n\n// SetContentParts sets Content to an array of content parts\nfunc (m *ChatMessage) SetContentParts(parts []ContentPart)\n\n// AddContentPart appends a content part (converts string to array if needed)\nfunc (m *ChatMessage) AddContentPart(part ContentPart)\n```\n\n## Backwards Compatibility\n\n- Existing code using `message.Content.(string)` should continue to work for text-only messages\n- JSON marshaling should produce string for text-only, array for multimodal\n- Consider custom MarshalJSON/UnmarshalJSON for clean serialization\n\n## File Location\n\nUpdate `pkg/types/models.go`","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-30T16:04:50.01505576Z","updated_at":"2025-11-30T16:04:50.01505576Z","dependencies":[{"issue_id":"workspace-3i4","depends_on_id":"workspace-lv0","type":"blocks","created_at":"2025-11-30T16:04:50.017521027Z","created_by":"daemon"}]}
{"id":"workspace-3sn","title":"Fix SA5011 nil pointer in auth tests","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:32:03.090581724Z","updated_at":"2025-11-29T11:35:55.004607258Z","closed_at":"2025-11-29T11:35:55.004607258Z"}
{"id":"workspace-3u5","title":"Standardize error handling across providers","description":"## Summary\nCreate unified error handling framework for all providers.\n\n## Current Issues\n- Error response parsing differs between providers\n- 429 rate limit handling inconsistent (Gemini has custom logic)\n- No standardized error classification\n- Error logging varies (Anthropic uses emoji prefixes, others minimal)\n\n## Proposed Solution\nCreate `pkg/providers/common/error_handling.go`:\n```go\ntype APIError struct {\n    StatusCode int\n    Type       string  // \"rate_limit\", \"auth\", \"invalid_request\", \"server_error\"\n    Message    string\n    RawBody    string\n    Retryable  bool\n}\n\nfunc (e *APIError) IsRateLimit() bool\nfunc (e *APIError) IsRetryable() bool\n\ntype ErrorClassifier interface {\n    Classify(statusCode int, body []byte) *APIError\n}\n\n// Each provider implements minimal classifier\ntype OpenAIErrorClassifier struct{}\ntype AnthropicErrorClassifier struct{}\n```\n\n## Impact\n- Consistent error handling across providers\n- Easier to implement retries and fallbacks\n- Better error reporting to clients\n\n## Complexity\nMedium - requires defining error types and updating each provider","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T12:57:23.458370062Z","updated_at":"2025-11-29T13:05:52.477916353Z","closed_at":"2025-11-29T13:05:52.477916353Z"}
{"id":"workspace-58u","title":"Tests: pkg/providers/gemini (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:57:44.2279014Z","updated_at":"2025-11-29T10:35:45.474891819Z","closed_at":"2025-11-29T10:35:45.474891819Z"}
{"id":"workspace-5vp","title":"Fix SA5011 nil pointer checks in config test","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:16:16.324094625Z","updated_at":"2025-11-29T11:18:04.187449509Z","closed_at":"2025-11-29T11:18:04.187449509Z"}
{"id":"workspace-5vy","title":"Tests: pkg/auth (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:57:42.220605018Z","updated_at":"2025-11-29T10:17:27.979994822Z","closed_at":"2025-11-29T10:17:27.979994822Z"}
{"id":"workspace-6n6","title":"Tests: pkg/providers/virtual/loadbalance (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:56:19.652638629Z","updated_at":"2025-11-29T10:17:27.964625551Z","closed_at":"2025-11-29T10:17:27.964625551Z"}
{"id":"workspace-7by","title":"Fix SA1029 context key type in types test","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:16:16.268479228Z","updated_at":"2025-11-29T11:18:04.161018629Z","closed_at":"2025-11-29T11:18:04.161018629Z"}
{"id":"workspace-7jc","title":"Standardize error handling with ProviderError type","description":"428 instances of error handling with varying patterns. Create ErrorCoder enum for classification, standardize error wrapping with context, implement ProviderError type with fields: code, message, statusCode, originalError. Improves debugging and consistency.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T19:27:30.011046999Z","updated_at":"2025-11-29T19:55:37.956776554Z","closed_at":"2025-11-29T19:55:37.956776554Z","dependencies":[{"issue_id":"workspace-7jc","depends_on_id":"workspace-tb7","type":"blocks","created_at":"2025-11-29T19:28:08.329807952Z","created_by":"daemon"}]}
{"id":"workspace-7y2","title":"Design MetricsCollector interface in pkg/types","description":"Create the central MetricsCollector interface that defines how consumers access metrics from ai-provider-kit.\n\n## Requirements\n- Single source of truth for all metrics\n- Snapshot API for polling (GetSnapshot, GetProviderMetrics, GetModelMetrics)\n- Event channel for real-time streaming (Subscribe, SubscribeFiltered)\n- Hook interface for synchronous callbacks (RegisterHook)\n- Thread-safe, lock-free where possible\n- Zero external dependencies (no OTEL/Prometheus in core)\n- Easy to serialize to any format (JSON, etc.)\n\n## Key Types to Define\n- MetricsCollector interface\n- MetricsSnapshot (aggregate)\n- ProviderMetricsSnapshot (per-provider)\n- ModelMetricsSnapshot (per-model)\n- MetricEvent + MetricEventType enum\n- MetricEventData interface + concrete types\n- MetricsHook interface\n- MetricFilter for subscriptions\n\n## Design Principles\n- ai-provider-kit provides the data, consumers decide export format\n- Event-driven for real-time, snapshot for polling\n- Rich data: latency percentiles, error types, token breakdown","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T16:55:02.447026642Z","updated_at":"2025-11-29T17:09:50.814989747Z","closed_at":"2025-11-29T17:09:50.814989747Z"}
{"id":"workspace-87j","title":"Qwen oauthOperation callback ignores token parameter, panics when OAuthManager is nil","description":"## The Bug\n\nWhen `ExecuteWithAuthMessage` detects a context-injected OAuth token and calls `oauthOperation(ctx, cred)`, the Qwen provider's callback ignores the credential parameter and instead calls `p.authHelper.OAuthManager.ExecuteWithFailover(...)` which panics because `OAuthManager` is nil.\n\n## Root Cause\n\nThe `ExecuteWithAuthMessage` signature passes a credential to the callback:\n```go\noauthOperation func(context.Context, *types.OAuthCredentialSet) (types.ChatMessage, *types.Usage, error)\n```\n\nBut Qwen's callback ignores the credential and calls its own failover logic:\n```go\noauthOperation := func(ctx context.Context, cred *types.OAuthCredentialSet) (types.ChatMessage, *types.Usage, error) {\n    return p.executeWithOAuthMessage(ctx, options)  // WRONG: ignores cred, uses OAuthManager\n}\n```\n\nInside `executeWithOAuthMessage`, it calls:\n```go\np.authHelper.OAuthManager.ExecuteWithFailoverMessage(ctx, ...)  // PANICS: OAuthManager is nil\n```\n\n## The Fix\n\nThe callback should use the provided credential directly:\n```go\noauthOperation := func(ctx context.Context, cred *types.OAuthCredentialSet) (types.ChatMessage, *types.Usage, error) {\n    return p.makeAPICallWithMessage(ctx, baseURL+\"/chat/completions\", request, cred.AccessToken)\n}\n```\n\nThe failover logic is already handled by `ExecuteWithAuthMessage` - the callback just needs to make a single API call with the provided token.\n\n## Same issue likely affects\n\n- Anthropic provider\n- Gemini provider\n\nAll providers' oauthOperation callbacks should use the provided credential, not their own failover logic.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-30T14:47:28.634480062Z","updated_at":"2025-11-30T14:50:20.486770257Z","closed_at":"2025-11-30T14:50:20.486770257Z"}
{"id":"workspace-8u7","title":"Implement OpenAI provider multimodal conversion","description":"## Overview\n\nUpdate OpenAI provider to convert ContentPart to OpenAI's native format.\n\n## OpenAI Native Format\n\n```json\n{\n  \"content\": [\n    {\"type\": \"text\", \"text\": \"What's in this image?\"},\n    {\"type\": \"image_url\", \"image_url\": {\"url\": \"data:image/png;base64,...\"}}\n  ]\n}\n```\n\n## Supported Content Types\n\n- `text` → `{type: \"text\", text: \"...\"}`\n- `image` (base64) → `{type: \"image_url\", image_url: {url: \"data:{media_type};base64,{data}\"}}`\n- `image` (url) → `{type: \"image_url\", image_url: {url: \"...\"}}`\n- `tool_use` → Handled via tool_calls field\n- `tool_result` → Handled via tool message role\n\n## Changes Required\n\n1. Update message building in `openai.go`\n2. Handle `ChatMessage.Content` as string or []ContentPart\n3. Convert base64 images to data URLs\n4. Map ContentPart types to OpenAI content array\n\n## Notes\n\nOpenAI uses `image_url` type with data URLs for base64, not separate base64 field.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-30T16:05:09.516262167Z","updated_at":"2025-11-30T16:05:09.516262167Z","dependencies":[{"issue_id":"workspace-8u7","depends_on_id":"workspace-3i4","type":"blocks","created_at":"2025-11-30T16:05:09.519124104Z","created_by":"daemon"}]}
{"id":"workspace-8zu","title":"Implement Anthropic provider multimodal conversion","description":"## Overview\n\nUpdate Anthropic provider to convert ContentPart to Anthropic's native format.\n\n## Anthropic Native Format\n\n```json\n{\n  \"content\": [\n    {\"type\": \"text\", \"text\": \"What's in this image?\"},\n    {\"type\": \"image\", \"source\": {\"type\": \"base64\", \"media_type\": \"image/png\", \"data\": \"...\"}}\n  ]\n}\n```\n\n## Supported Content Types\n\n- `text` → `{type: \"text\", text: \"...\"}`\n- `image` → `{type: \"image\", source: {type, media_type, data/url}}`\n- `document` → `{type: \"document\", source: {...}}`\n- `tool_use` → `{type: \"tool_use\", id, name, input}`\n- `tool_result` → `{type: \"tool_result\", tool_use_id, content}`\n- `thinking` → `{type: \"thinking\", thinking: \"...\"}`\n\n## Changes Required\n\n1. Update `convertToAnthropicContent()` in `anthropic.go`\n2. Handle `ChatMessage.Content` as string or []ContentPart\n3. Map ContentPart types to Anthropic content blocks\n4. Handle MediaSource conversion (base64/url)\n\n## Notes\n\nAnthropic's format is closest to our ContentPart design, so conversion should be straightforward.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-30T16:04:59.515409032Z","updated_at":"2025-11-30T16:04:59.515409032Z","dependencies":[{"issue_id":"workspace-8zu","depends_on_id":"workspace-3i4","type":"blocks","created_at":"2025-11-30T16:04:59.563918378Z","created_by":"daemon"}]}
{"id":"workspace-94g","title":"Split Extension interface into capability-based interfaces","description":"## Summary\nSplit the monolithic Extension interface into smaller, focused interfaces that extensions can selectively implement.\n\n## Motivation\nCurrent interface requires implementing all hooks (even as no-ops via BaseExtension):\n- Extensions only need 1-2 hooks typically\n- Adding new hooks requires updating BaseExtension\n- No clear indication of what an extension actually does\n\n## Proposed Interfaces\n```go\n// Core metadata (required)\ntype Extension interface {\n    Name() string\n    Version() string\n    Description() string\n}\n\n// Optional capability interfaces\ntype Initializable interface {\n    Initialize(config map[string]interface{}) error\n    Shutdown(ctx context.Context) error\n}\n\ntype BeforeGenerateHook interface {\n    BeforeGenerate(ctx context.Context, req *GenerateRequest) error\n}\n\ntype AfterGenerateHook interface {\n    AfterGenerate(ctx context.Context, req *GenerateRequest, resp *GenerateResponse) error\n}\n\ntype ProviderErrorHandler interface {\n    OnProviderError(ctx context.Context, provider Provider, err error) error\n}\n\ntype ProviderSelectionHook interface {\n    OnProviderSelected(ctx context.Context, provider Provider) error\n}\n\ntype RouteProvider interface {\n    RegisterRoutes(registrar RouteRegistrar) error\n}\n\ntype DependencyDeclarer interface {\n    Dependencies() []string\n}\n```\n\n## Registry Changes\n```go\nfunc (r *Registry) callBeforeGenerate(ctx context.Context, req *GenerateRequest) error {\n    for _, ext := range r.extensions {\n        if hook, ok := ext.(BeforeGenerateHook); ok {\n            if err := hook.BeforeGenerate(ctx, req); err != nil {\n                return err\n            }\n        }\n    }\n    return nil\n}\n```\n\n## Benefits\n- Extensions only implement what they need\n- Clear capability discovery via type assertions\n- Easier to add new hook types without breaking existing extensions\n- Self-documenting (check which interfaces are implemented)\n\n## Migration Path\n- Keep current Extension interface as composite (embeds all capability interfaces)\n- BaseExtension implements all for backward compatibility\n- New extensions can implement subset","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T12:20:17.333097621Z","updated_at":"2025-11-29T12:26:09.079755156Z","closed_at":"2025-11-29T12:26:09.079755156Z"}
{"id":"workspace-9dq","title":"Fix duplicate code in errors_test.go","description":"golangci-lint dupl: pkg/providers/openai/errors_test.go has multiple duplicate sections (lines 18-232 have 6 duplicate blocks, and lines 234-330 have another pair). Refactor to use table-driven tests or helper functions.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T10:49:49.583326487Z","updated_at":"2025-11-29T10:58:15.654737477Z","closed_at":"2025-11-29T10:58:15.654737477Z"}
{"id":"workspace-9gy","title":"Fix G115 integer overflow in loadbalance test","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:16:16.190949726Z","updated_at":"2025-11-29T11:18:04.120042543Z","closed_at":"2025-11-29T11:18:04.120042543Z"}
{"id":"workspace-9s5","title":"APK 3.3: Add Streaming Support","description":"#### Task 3.3: Add Streaming Support\n**Priority:** P1 - High\n**Estimated Effort:** 8 hours\n\n**Features:**\n- SSE endpoint for streaming generation\n- Proper connection handling\n- Extension hooks for streaming\n\n**Acceptance Criteria:**\n- [ ] SSE endpoint for streaming generation\n- [ ] Proper connection handling\n- [ ] Extension hooks for streaming","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:47.054071964Z","updated_at":"2025-11-29T02:38:25.602814265Z","closed_at":"2025-11-29T02:38:25.602814265Z","dependencies":[{"issue_id":"workspace-9s5","depends_on_id":"workspace-sqx","type":"blocks","created_at":"2025-11-29T02:00:40.352362183Z","created_by":"daemon"}]}
{"id":"workspace-9wd","title":"Extract shared SSE utilities to handlers/sse.go","description":"## Summary\nExtract duplicated SSE (Server-Sent Events) utility functions from generate.go and stream.go into a shared sse.go file.\n\n## Duplicated Code (80+ lines)\n- `setupSSE()` - identical in both files\n- `sendChunkAsSSE()` - identical\n- `sendDoneEvent()` - identical  \n- `sendSSEError()` - identical\n\n## Proposed Solution\nCreate `pkg/backend/handlers/sse.go`:\n```go\ntype SSEWriter struct {\n    w       http.ResponseWriter\n    flusher http.Flusher\n}\n\nfunc NewSSEWriter(w http.ResponseWriter) (*SSEWriter, error)\nfunc (s *SSEWriter) WriteChunk(chunk types.ChatCompletionChunk) error\nfunc (s *SSEWriter) WriteDone()\nfunc (s *SSEWriter) WriteError(code, message string)\n```\n\n## Complexity\nLow - straightforward extraction with no behavioral changes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T12:57:15.470438864Z","updated_at":"2025-11-29T13:06:44.580612748Z","closed_at":"2025-11-29T13:06:44.580612748Z"}
{"id":"workspace-a3a","title":"Fix duplicate code in health_test.go","description":"golangci-lint dupl: pkg/providers/common/health_test.go:185-231 lines are duplicate of lines 233-279. Refactor to eliminate duplication.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T10:49:47.624658874Z","updated_at":"2025-11-29T10:58:15.644302716Z","closed_at":"2025-11-29T10:58:15.644302716Z"}
{"id":"workspace-agn","title":"Implement SSE streaming in GenerateHandler","description":"Location: pkg/backend/handlers/generate.go:145\n\nThe GenerateHandler currently returns NOT_IMPLEMENTED for streaming requests. SSE streaming should be implemented to handle streaming generation requests.\n\nNote: StreamHandler already exists - this TODO may be outdated and just needs the comment removed or the code updated to redirect to StreamHandler.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T11:51:37.918807183Z","updated_at":"2025-11-29T11:56:18.176074421Z","closed_at":"2025-11-29T11:56:18.176074421Z"}
{"id":"workspace-am2","title":"Fix SA4006 unused value in models test","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:16:16.297088679Z","updated_at":"2025-11-29T11:18:04.173968709Z","closed_at":"2025-11-29T11:18:04.173968709Z"}
{"id":"workspace-atw","title":"Tests: pkg/providers/qwen (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:57:45.178960365Z","updated_at":"2025-11-29T10:35:45.434353107Z","closed_at":"2025-11-29T10:35:45.434353107Z"}
{"id":"workspace-b3v","title":"Add support for reasoning and reasoning_content fields in OpenAI-compatible provider","description":"## Problem\nSeveral OpenAI-compatible APIs (Synthetic, OpenCode/Zen, and models like GLM-4.6 on Cerebras) return model responses in non-standard fields:\n\n### 1. reasoning field (Cerebras GLM-4.6, OpenCode/Zen):\n```json\n{\n  \"choices\": [{\n    \"message\": {\n      \"content\": \"\\n\",\n      \"reasoning\": \"1. Analyze the user's request...\\n\\nActual answer: Hello!\",\n      \"role\": \"assistant\"\n    }\n  }]\n}\n```\n\n### 2. reasoning_content field (Synthetic/vLLM):\n```json\n{\n  \"choices\": [{\n    \"message\": {\n      \"content\": null,\n      \"reasoning_content\": \"The user asks 2+2. The answer is 4.\",\n      \"role\": \"assistant\"\n    }\n  }]\n}\n```\n\n## Current Behavior\nThe OpenAI provider only extracts the `content` field, resulting in empty responses when models put their output in reasoning fields.\n\n## Requested Behavior\n1. Add `Reasoning` and `ReasoningContent` fields to `OpenAIMessage` struct\n2. When content is empty/null, fallback to `reasoning_content` or `reasoning`\n3. Optionally expose reasoning in `types.ChatCompletionChunk` for clients that want it\n\n## Affected Models\n- GLM-4.6 family (zai-glm-4.6, hf:zai-org/GLM-4.6, big-pickle)\n- Any reasoning-enabled model on vLLM/Synthetic\n\n## Files to Modify\n- `pkg/providers/openai/openai.go` - response parsing\n- `pkg/types/provider.go` - add Reasoning field to ChatMessage/ChatCompletionChunk","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T14:53:34.893785867Z","updated_at":"2025-11-29T15:00:07.290293916Z","closed_at":"2025-11-29T15:00:07.290293916Z"}
{"id":"workspace-bsb","title":"Consolidate duplicate Usage and HealthStatus types","description":"## Summary\nConsolidate duplicate type definitions between pkg/types and pkg/backendtypes.\n\n## Duplicate Types\n1. **Usage vs UsageInfo** (identical fields)\n   - `pkg/types/models.go`: Usage struct\n   - `pkg/backendtypes/responses.go`: UsageInfo struct\n   \n2. **HealthStatus variants** (3 different structures)\n   - `pkg/types/provider.go`: HealthStatus\n   - `pkg/types/metrics.go`: RouterHealthStatus\n   - `pkg/backendtypes/responses.go`: ProviderHealth\n\n## Proposed Solution\n1. Keep single `Usage` type in types package\n2. Add type alias in backendtypes: `type UsageInfo = types.Usage`\n3. Consolidate to single `HealthStatus` type\n4. Remove conversion code in handlers (~15 lines per handler)\n\n## Complexity\nLow - type consolidation with aliases for backward compatibility","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T12:57:18.161356454Z","updated_at":"2025-11-29T13:06:37.572223149Z","closed_at":"2025-11-29T13:06:37.572223149Z"}
{"id":"workspace-bzp","title":"Tests: pkg/keymanager (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:57:42.737318943Z","updated_at":"2025-11-29T10:17:28.006915125Z","closed_at":"2025-11-29T10:17:28.006915125Z"}
{"id":"workspace-caj","title":"Fix staticcheck SA9003 empty branch in collector.go","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T18:19:58.873380246Z","updated_at":"2025-11-29T18:20:18.365199729Z","closed_at":"2025-11-29T18:20:18.365199729Z"}
{"id":"workspace-cav","title":"Tests: pkg/backend/handlers (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:56:18.369942132Z","updated_at":"2025-11-29T10:05:55.860349637Z","closed_at":"2025-11-29T10:05:55.860349637Z"}
{"id":"workspace-cb0","title":"Fix errcheck in backend middleware","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:22:59.455053989Z","updated_at":"2025-11-29T11:27:13.921537493Z","closed_at":"2025-11-29T11:27:13.921537493Z"}
{"id":"workspace-cc7","title":"Implement generic SSE stream parser for providers","description":"## Summary\nCreate a generic SSE stream parser to eliminate 300+ lines of duplicated streaming code across 6 providers.\n\n## Current Duplication\nEach provider implements nearly identical SSE parsing:\n- Create bufio.Reader wrapper\n- Read lines until EOF\n- Skip empty/non-data lines\n- Parse JSON from \"data: \" prefix\n- Handle \"[DONE]\" sentinel\n- Extract content and usage\n\nDuplicated in: anthropic, openai, gemini, qwen, cerebras, openrouter\n\n## Proposed Solution\nExtend `pkg/providers/common/streaming.go`:\n```go\ntype GenericSSEStream struct {\n    response *http.Response\n    reader   *bufio.Reader\n    done     bool\n    mutex    sync.Mutex\n    parser   SSELineParser\n}\n\ntype SSELineParser interface {\n    IsTerminal(line string) bool\n    Parse(line string) (types.ChatCompletionChunk, error)\n}\n\n// Each provider provides minimal parser\ntype OpenAISSEParser struct{}\ntype AnthropicSSEParser struct{}\n```\n\n## Impact\n- Reduces 50+ lines per provider to 10-15\n- Single tested implementation of SSE parsing\n- Easier to add new providers\n\n## Complexity\nMedium-High - requires careful interface design for provider variations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T12:57:21.987748203Z","updated_at":"2025-11-29T13:06:33.945306021Z","closed_at":"2025-11-29T13:06:33.945306021Z"}
{"id":"workspace-cfb","title":"Add cost metrics with pluggable pricing","description":"Add cost tracking to the metrics system. Since pricing changes frequently and varies by contract, use a pluggable approach.\n\n## Design\n\n### CostCalculator Interface\n```go\ntype CostCalculator interface {\n    // Calculate cost for a request\n    CalculateCost(provider, model string, inputTokens, outputTokens int64) Cost\n    \n    // Get pricing info (for display/debugging)\n    GetPricing(provider, model string) (inputPer1K, outputPer1K float64, ok bool)\n}\n\ntype Cost struct {\n    InputCost    float64\n    OutputCost   float64\n    TotalCost    float64\n    Currency     string  // default USD\n}\n```\n\n### CostMetrics in Snapshot\n```go\ntype CostSnapshot struct {\n    TotalCost        float64\n    CostByProvider   map[string]float64\n    CostByModel      map[string]float64\n    LastHourCost     float64  // Rolling window\n    Last24HourCost   float64\n    AvgCostPerRequest float64\n}\n```\n\n### Implementation Options\n\n1. **Consumer provides CostCalculator**\n   - ai-provider-kit has no pricing data\n   - Cortex/VelocityCode implement their own\n   - Most flexible, always accurate\n\n2. **Optional default pricing (can be overridden)**\n   - Include rough pricing as fallback\n   - Consumers can override with their negotiated rates\n\n## Recommendation\nOption 1 - keep ai-provider-kit pricing-agnostic. Consumers know their costs better.\n\n## Integration\n- MetricsCollector accepts optional CostCalculator\n- Cost calculated on RequestCompleteEvent\n- Aggregate costs in snapshot","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T16:56:46.335967054Z","updated_at":"2025-11-29T17:28:03.344392299Z","closed_at":"2025-11-29T17:28:03.344392299Z","dependencies":[{"issue_id":"workspace-cfb","depends_on_id":"workspace-g8q","type":"blocks","created_at":"2025-11-29T16:56:51.72344914Z","created_by":"daemon"}]}
{"id":"workspace-co0","title":"APK 1.4: Implement Racing Virtual Provider","description":"#### Task 1.4: Implement Racing Virtual Provider\n**Priority:** P0 - Blocking\n**Estimated Effort:** 8 hours\n\n**File:** `pkg/providers/virtual/racing/provider.go`\n\n```go\npackage racing\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"sync\"\n    \"time\"\n\n    \"github.com/anthropics/ai-provider-kit/pkg/types\"\n)\n\n// RacingProvider races multiple providers and returns the first successful response\ntype RacingProvider struct {\n    name        string\n    providers   []types.Provider\n    config      *Config\n    performance *PerformanceTracker\n    mu          sync.RWMutex\n}\n\ntype Config struct {\n    TimeoutMS       int      `yaml:\"timeout_ms\"`\n    GracePeriodMS   int      `yaml:\"grace_period_ms\"`\n    Strategy        Strategy `yaml:\"strategy\"`\n    ProviderNames   []string `yaml:\"providers\"`\n    PerformanceFile string   `yaml:\"performance_file,omitempty\"`\n}\n\ntype Strategy string\n\nconst (\n    StrategyFirstWins Strategy = \"first_wins\"\n    StrategyWeighted  Strategy = \"weighted\"\n    StrategyQuality   Strategy = \"quality\"\n)\n\ntype raceResult struct {\n    index    int\n    provider types.Provider\n    stream   types.ChatCompletionStream\n    err      error\n    latency  time.Duration\n}\n\nfunc NewRacingProvider(name string, config *Config) *RacingProvider {\n    return \u0026RacingProvider{\n        name:        name,\n        config:      config,\n        performance: NewPerformanceTracker(),\n    }\n}\n\n// SetProviders sets the providers to race\nfunc (r *RacingProvider) SetProviders(providers []types.Provider) {\n    r.mu.Lock()\n    defer r.mu.Unlock()\n    r.providers = providers\n}\n\n// Provider interface implementation\nfunc (r *RacingProvider) Name() string                  { return r.name }\nfunc (r *RacingProvider) Type() types.ProviderType     { return \"racing\" }\nfunc (r *RacingProvider) Description() string          { return \"Races multiple providers for fastest response\" }\n\n// ChatProvider interface implementation\nfunc (r *RacingProvider) GenerateChatCompletion(ctx context.Context, opts types.GenerateOptions) (types.ChatCompletionStream, error) {\n    r.mu.RLock()\n    providers := r.providers\n    r.mu.RUnlock()\n\n    if len(providers) == 0 {\n        return nil, fmt.Errorf(\"no providers configured for racing\")\n    }\n\n    timeout := time.Duration(r.config.TimeoutMS) * time.Millisecond\n    ctx, cancel := context.WithTimeout(ctx, timeout)\n    defer cancel()\n\n    results := make(chan *raceResult, len(providers))\n    var wg sync.WaitGroup\n\n    // Start all providers racing\n    for i, provider := range providers {\n        wg.Add(1)\n        go func(idx int, p types.Provider) {\n            defer wg.Done()\n            start := time.Now()\n\n            chatProvider, ok := p.(types.ChatProvider)\n            if !ok {\n                results \u003c- \u0026raceResult{index: idx, provider: p, err: fmt.Errorf(\"provider does not support chat\")}\n                return\n            }\n\n            stream, err := chatProvider.GenerateChatCompletion(ctx, opts)\n            results \u003c- \u0026raceResult{\n                index:    idx,\n                provider: p,\n                stream:   stream,\n                err:      err,\n                latency:  time.Since(start),\n            }\n        }(i, provider)\n    }\n\n    // Close results channel when all done\n    go func() {\n        wg.Wait()\n        close(results)\n    }()\n\n    // Select winner based on strategy\n    return r.selectWinner(ctx, results)\n}\n\nfunc (r *RacingProvider) selectWinner(ctx context.Context, results chan *raceResult) (types.ChatCompletionStream, error) {\n    switch r.config.Strategy {\n    case StrategyWeighted:\n        return r.weightedStrategy(ctx, results)\n    case StrategyQuality:\n        return r.qualityStrategy(ctx, results)\n    default:\n        return r.firstWinsStrategy(ctx, results)\n    }\n}\n\nfunc (r *RacingProvider) firstWinsStrategy(ctx context.Context, results chan *raceResult) (types.ChatCompletionStream, error) {\n    var lastErr error\n    for result := range results {\n        if result.err == nil \u0026\u0026 result.stream != nil {\n            r.performance.RecordWin(result.provider.Name(), result.latency)\n            return \u0026racingStream{\n                inner:    result.stream,\n                provider: result.provider.Name(),\n                latency:  result.latency,\n            }, nil\n        }\n        if result.err != nil {\n            r.performance.RecordLoss(result.provider.Name(), result.latency)\n            lastErr = result.err\n        }\n    }\n    if lastErr != nil {\n        return nil, fmt.Errorf(\"all providers failed, last error: %w\", lastErr)\n    }\n    return nil, fmt.Errorf(\"all providers failed\")\n}\n\nfunc (r *RacingProvider) weightedStrategy(ctx context.Context, results chan *raceResult) (types.ChatCompletionStream, error) {\n    // Collect results during grace period, pick best based on historical performance\n    gracePeriod := time.Duration(r.config.GracePeriodMS) * time.Millisecond\n    timer := time.NewTimer(gracePeriod)\n    defer timer.Stop()\n\n    var candidates []*raceResult\n\n    for {\n        select {\n        case result, ok := \u003c-results:\n            if !ok {\n                // All results received\n                return r.pickBestCandidate(candidates)\n            }\n            if result.err == nil \u0026\u0026 result.stream != nil {\n                candidates = append(candidates, result)\n                // If we have a result and grace period hasn't started, start it\n                if len(candidates) == 1 {\n                    timer.Reset(gracePeriod)\n                }\n            }\n        case \u003c-timer.C:\n            // Grace period expired, pick from candidates\n            if len(candidates) \u003e 0 {\n                return r.pickBestCandidate(candidates)\n            }\n            // No candidates yet, continue waiting\n        case \u003c-ctx.Done():\n            if len(candidates) \u003e 0 {\n                return r.pickBestCandidate(candidates)\n            }\n            return nil, ctx.Err()\n        }\n    }\n}\n\nfunc (r *RacingProvider) qualityStrategy(ctx context.Context, results chan *raceResult) (types.ChatCompletionStream, error) {\n    // Wait for all results (up to timeout), then pick best\n    return r.weightedStrategy(ctx, results)\n}\n\nfunc (r *RacingProvider) pickBestCandidate(candidates []*raceResult) (types.ChatCompletionStream, error) {\n    if len(candidates) == 0 {\n        return nil, fmt.Errorf(\"no successful candidates\")\n    }\n\n    // Score candidates based on historical performance\n    var best *raceResult\n    var bestScore float64 = -1\n\n    for _, c := range candidates {\n        score := r.performance.GetScore(c.provider.Name())\n        // Adjust score by latency (faster is better)\n        latencyFactor := 1.0 / (1.0 + c.latency.Seconds())\n        adjustedScore := score * latencyFactor\n\n        if adjustedScore \u003e bestScore {\n            bestScore = adjustedScore\n            best = c\n        }\n    }\n\n    if best != nil {\n        r.performance.RecordWin(best.provider.Name(), best.latency)\n        return \u0026racingStream{\n            inner:    best.stream,\n            provider: best.provider.Name(),\n            latency:  best.latency,\n        }, nil\n    }\n\n    // Fallback to first candidate\n    r.performance.RecordWin(candidates[0].provider.Name(), candidates[0].latency)\n    return \u0026racingStream{\n        inner:    candidates[0].stream,\n        provider: candidates[0].provider.Name(),\n        latency:  candidates[0].latency,\n    }, nil\n}\n\n// GetPerformanceStats returns performance statistics for all providers\nfunc (r *RacingProvider) GetPerformanceStats() map[string]*ProviderStats {\n    return r.performance.GetAllStats()\n}\n\n// racingStream wraps a stream with racing metadata\ntype racingStream struct {\n    inner    types.ChatCompletionStream\n    provider string\n    latency  time.Duration\n}\n\nfunc (s *racingStream) Next() (types.ChatCompletionChunk, error) {\n    chunk, err := s.inner.Next()\n    // Add racing metadata to first chunk\n    if chunk.Metadata == nil {\n        chunk.Metadata = make(map[string]interface{})\n    }\n    chunk.Metadata[\"racing_winner\"] = s.provider\n    chunk.Metadata[\"racing_latency_ms\"] = s.latency.Milliseconds()\n    return chunk, err\n}\n\nfunc (s *racingStream) Close() error {\n    return s.inner.Close()\n}\n```\n\n**File:** `pkg/providers/virtual/racing/performance.go`\n\n```go\npackage racing\n\nimport (\n    \"sync\"\n    \"time\"\n)\n\ntype PerformanceTracker struct {\n    mu    sync.RWMutex\n    stats map[string]*ProviderStats\n}\n\ntype ProviderStats struct {\n    TotalRaces   int64         `json:\"total_races\"`\n    Wins         int64         `json:\"wins\"`\n    Losses       int64         `json:\"losses\"`\n    AvgLatency   time.Duration `json:\"avg_latency\"`\n    TotalLatency time.Duration `json:\"-\"`\n    WinRate      float64       `json:\"win_rate\"`\n    LastUpdated  time.Time     `json:\"last_updated\"`\n}\n\nfunc NewPerformanceTracker() *PerformanceTracker {\n    return \u0026PerformanceTracker{\n        stats: make(map[string]*ProviderStats),\n    }\n}\n\nfunc (pt *PerformanceTracker) RecordWin(provider string, latency time.Duration) {\n    pt.mu.Lock()\n    defer pt.mu.Unlock()\n\n    stats := pt.getOrCreate(provider)\n    stats.TotalRaces++\n    stats.Wins++\n    stats.TotalLatency += latency\n    stats.AvgLatency = stats.TotalLatency / time.Duration(stats.TotalRaces)\n    stats.WinRate = float64(stats.Wins) / float64(stats.TotalRaces)\n    stats.LastUpdated = time.Now()\n}\n\nfunc (pt *PerformanceTracker) RecordLoss(provider string, latency time.Duration) {\n    pt.mu.Lock()\n    defer pt.mu.Unlock()\n\n    stats := pt.getOrCreate(provider)\n    stats.TotalRaces++\n    stats.Losses++\n    stats.TotalLatency += latency\n    stats.AvgLatency = stats.TotalLatency / time.Duration(stats.TotalRaces)\n    stats.WinRate = float64(stats.Wins) / float64(stats.TotalRaces)\n    stats.LastUpdated = time.Now()\n}\n\nfunc (pt *PerformanceTracker) GetScore(provider string) float64 {\n    pt.mu.RLock()\n    defer pt.mu.RUnlock()\n\n    stats, ok := pt.stats[provider]\n    if !ok {\n        return 0.5 // Default score for new providers\n    }\n\n    // Score based on win rate (0.0 to 1.0)\n    return stats.WinRate\n}\n\nfunc (pt *PerformanceTracker) GetAllStats() map[string]*ProviderStats {\n    pt.mu.RLock()\n    defer pt.mu.RUnlock()\n\n    result := make(map[string]*ProviderStats)\n    for k, v := range pt.stats {\n        statsCopy := *v\n        result[k] = \u0026statsCopy\n    }\n    return result\n}\n\nfunc (pt *PerformanceTracker) getOrCreate(provider string) *ProviderStats {\n    stats, ok := pt.stats[provider]\n    if !ok {\n        stats = \u0026ProviderStats{}\n        pt.stats[provider] = stats\n    }\n    return stats\n}\n```\n\n**Acceptance Criteria:**\n- [ ] Racing provider implements types.Provider and types.ChatProvider\n- [ ] First-wins strategy implemented\n- [ ] Weighted strategy with grace period implemented\n- [ ] Performance tracking with win rates\n- [ ] Thread-safe implementation\n- [ ] Unit tests for all strategies","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:17.398548382Z","updated_at":"2025-11-29T02:16:08.921123345Z","closed_at":"2025-11-29T02:16:08.921123345Z","dependencies":[{"issue_id":"workspace-co0","depends_on_id":"workspace-30d","type":"blocks","created_at":"2025-11-29T02:00:38.045389978Z","created_by":"daemon"}]}
{"id":"workspace-cr1","title":"Fix data race in HealthChecker Start/Stop","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T13:12:48.97548233Z","updated_at":"2025-11-29T13:15:37.673702067Z","closed_at":"2025-11-29T13:15:37.673702067Z"}
{"id":"workspace-cu3","title":"Tests: pkg/oauthmanager (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:57:43.008144248Z","updated_at":"2025-11-29T10:17:28.019502426Z","closed_at":"2025-11-29T10:17:28.019502426Z"}
{"id":"workspace-d25","title":"Tests: pkg/providers/anthropic (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:57:43.624151217Z","updated_at":"2025-11-29T10:17:28.041610231Z","closed_at":"2025-11-29T10:17:28.041610231Z"}
{"id":"workspace-dah","title":"Fix remaining errcheck issues","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:32:03.036907806Z","updated_at":"2025-11-29T11:35:54.959109794Z","closed_at":"2025-11-29T11:35:54.959109794Z"}
{"id":"workspace-dm0","title":"APK 4.2: Performance Optimization","description":"#### Task 4.2: Performance Optimization\n**Priority:** P2 - Medium\n**Estimated Effort:** 8 hours\n\n- [ ] Profile and optimize hot paths\n- [ ] Racing provider optimization\n- [ ] Connection pooling","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T02:00:00.00795712Z","updated_at":"2025-11-29T02:38:25.622446493Z","closed_at":"2025-11-29T02:38:25.622446493Z","dependencies":[{"issue_id":"workspace-dm0","depends_on_id":"workspace-sqx","type":"blocks","created_at":"2025-11-29T02:00:41.067403809Z","created_by":"daemon"},{"issue_id":"workspace-dm0","depends_on_id":"workspace-30w","type":"blocks","created_at":"2025-11-29T02:00:41.077479909Z","created_by":"daemon"}]}
{"id":"workspace-e40","title":"Fix ineffassign issues","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:32:03.075665147Z","updated_at":"2025-11-29T11:35:54.993442838Z","closed_at":"2025-11-29T11:35:54.993442838Z"}
{"id":"workspace-e88","title":"Fix code formatting: gci, gofmt, stylecheck issues","description":"golangci-lint formatting failures:\n- gci: Import ordering issues in multiple files\n- gofmt: File not properly formatted (metrics_snapshot.go)\n- stylecheck: Missing package comments in pkg/metrics/\n\nFiles affected:\n- pkg/metrics/collector.go\n- pkg/metrics/histogram.go\n- pkg/metrics/stream_wrapper.go\n- pkg/metrics/cost_test.go\n- pkg/metrics/histogram_test.go\n- pkg/metrics/example_test.go\n- pkg/types/metrics_collector.go\n- pkg/types/metrics_snapshot.go","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T18:04:38.428391257Z","updated_at":"2025-11-29T18:12:53.800571114Z","closed_at":"2025-11-29T18:12:53.800571114Z"}
{"id":"workspace-ezv","title":"APK 1.3: Define API Request/Response Types","description":"#### Task 1.3: Define API Request/Response Types\n**Priority:** P0 - Blocking\n**Estimated Effort:** 4 hours\n\n**File:** `pkg/backendtypes/requests.go`\n\n```go\npackage backendtypes\n\nimport \"github.com/anthropics/ai-provider-kit/pkg/types\"\n\n// GenerateRequest represents a code/chat generation request\ntype GenerateRequest struct {\n    Provider    string                 `json:\"provider,omitempty\"`\n    Model       string                 `json:\"model,omitempty\"`\n    Prompt      string                 `json:\"prompt\"`\n    Messages    []types.ChatMessage    `json:\"messages,omitempty\"`\n    MaxTokens   int                    `json:\"max_tokens,omitempty\"`\n    Temperature float64                `json:\"temperature,omitempty\"`\n    Stream      bool                   `json:\"stream,omitempty\"`\n    Tools       []types.Tool           `json:\"tools,omitempty\"`\n    Metadata    map[string]interface{} `json:\"metadata,omitempty\"`\n}\n\n// ProviderConfigRequest for updating provider configuration\ntype ProviderConfigRequest struct {\n    Type         string   `json:\"type\"`\n    APIKey       string   `json:\"api_key,omitempty\"`\n    APIKeys      []string `json:\"api_keys,omitempty\"`\n    DefaultModel string   `json:\"default_model,omitempty\"`\n    BaseURL      string   `json:\"base_url,omitempty\"`\n    Enabled      bool     `json:\"enabled\"`\n}\n```\n\n**File:** `pkg/backendtypes/responses.go`\n\n```go\npackage backendtypes\n\nimport \"time\"\n\n// APIResponse is the standard response wrapper\ntype APIResponse struct {\n    Success   bool        `json:\"success\"`\n    Data      interface{} `json:\"data,omitempty\"`\n    Error     *APIError   `json:\"error,omitempty\"`\n    RequestID string      `json:\"request_id,omitempty\"`\n    Timestamp time.Time   `json:\"timestamp\"`\n}\n\ntype APIError struct {\n    Code    string `json:\"code\"`\n    Message string `json:\"message\"`\n    Details string `json:\"details,omitempty\"`\n}\n\n// GenerateResponse for code/chat generation\ntype GenerateResponse struct {\n    Content  string                 `json:\"content\"`\n    Model    string                 `json:\"model\"`\n    Provider string                 `json:\"provider\"`\n    Usage    *UsageInfo             `json:\"usage,omitempty\"`\n    Metadata map[string]interface{} `json:\"metadata,omitempty\"`\n}\n\ntype UsageInfo struct {\n    PromptTokens     int `json:\"prompt_tokens\"`\n    CompletionTokens int `json:\"completion_tokens\"`\n    TotalTokens      int `json:\"total_tokens\"`\n}\n\n// ProviderInfo for provider listing\ntype ProviderInfo struct {\n    Name        string   `json:\"name\"`\n    Type        string   `json:\"type\"`\n    Enabled     bool     `json:\"enabled\"`\n    Healthy     bool     `json:\"healthy\"`\n    Models      []string `json:\"models,omitempty\"`\n    Description string   `json:\"description,omitempty\"`\n}\n\n// HealthResponse for health endpoints\ntype HealthResponse struct {\n    Status    string                    `json:\"status\"`\n    Version   string                    `json:\"version\"`\n    Uptime    string                    `json:\"uptime\"`\n    Providers map[string]ProviderHealth `json:\"providers,omitempty\"`\n}\n\ntype ProviderHealth struct {\n    Status  string `json:\"status\"`\n    Latency int64  `json:\"latency_ms\"`\n    Message string `json:\"message,omitempty\"`\n}\n```\n\n**Acceptance Criteria:**\n- [ ] All request types defined with validation tags\n- [ ] All response types defined with JSON tags\n- [ ] Consistent with existing types.* types\n- [ ] Unit tests for serialization/deserialization","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:16.244023832Z","updated_at":"2025-11-29T02:16:08.267366835Z","closed_at":"2025-11-29T02:16:08.267366835Z","dependencies":[{"issue_id":"workspace-ezv","depends_on_id":"workspace-30d","type":"blocks","created_at":"2025-11-29T02:00:38.035154841Z","created_by":"daemon"}]}
{"id":"workspace-f5c","title":"Fix duplicate code in racing_test.go","description":"golangci-lint dupl: pkg/providers/virtual/racing/racing_test.go:287-331 lines are duplicate of lines 333-379. Refactor to eliminate duplication.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T10:49:45.831062202Z","updated_at":"2025-11-29T10:58:15.620486252Z","closed_at":"2025-11-29T10:58:15.620486252Z"}
{"id":"workspace-fc4","title":"APK 1.7: Create Extension Framework Interface","description":"**Task 1.7: Create Extension Framework Interface**\n\n**Priority:** P0 - Blocking\n**Estimated Effort:** 6 hours\n\n**File:** `pkg/backend/extensions/interface.go`\n\n```go\npackage extensions\n\nimport (\n    \"context\"\n    \"net/http\"\n\n    \"github.com/anthropics/ai-provider-kit/pkg/backendtypes\"\n    \"github.com/anthropics/ai-provider-kit/pkg/types\"\n)\n\n// Extension defines the interface for backend extensions\ntype Extension interface {\n    // Metadata\n    Name() string\n    Version() string\n    Description() string\n    Dependencies() []string\n\n    // Lifecycle\n    Initialize(config map[string]interface{}) error\n    Shutdown(ctx context.Context) error\n\n    // Route registration (optional)\n    RegisterRoutes(registrar RouteRegistrar) error\n\n    // Request/Response hooks (optional - return nil to skip)\n    BeforeGenerate(ctx context.Context, req *backendtypes.GenerateRequest) error\n    AfterGenerate(ctx context.Context, req *backendtypes.GenerateRequest, resp *backendtypes.GenerateResponse) error\n\n    // Provider hooks (optional)\n    OnProviderError(ctx context.Context, provider types.Provider, err error) error\n    OnProviderSelected(ctx context.Context, provider types.Provider) error\n}\n\n// RouteRegistrar allows extensions to register custom routes\ntype RouteRegistrar interface {\n    Handle(pattern string, handler http.Handler)\n    HandleFunc(pattern string, handler http.HandlerFunc)\n}\n\n// ExtensionRegistry manages extension lifecycle\ntype ExtensionRegistry interface {\n    Register(ext Extension) error\n    Get(name string) (Extension, bool)\n    List() []Extension\n    Initialize(configs map[string]backendtypes.ExtensionConfig) error\n    Shutdown(ctx context.Context) error\n}\n\n// BaseExtension provides default implementations for optional methods\ntype BaseExtension struct{}\n\nfunc (b *BaseExtension) Dependencies() []string { return nil }\nfunc (b *BaseExtension) RegisterRoutes(r RouteRegistrar) error { return nil }\nfunc (b *BaseExtension) BeforeGenerate(ctx context.Context, req *backendtypes.GenerateRequest) error { return nil }\nfunc (b *BaseExtension) AfterGenerate(ctx context.Context, req *backendtypes.GenerateRequest, resp *backendtypes.GenerateResponse) error { return nil }\nfunc (b *BaseExtension) OnProviderError(ctx context.Context, provider types.Provider, err error) error { return nil }\nfunc (b *BaseExtension) OnProviderSelected(ctx context.Context, provider types.Provider) error { return nil }\nfunc (b *BaseExtension) Shutdown(ctx context.Context) error { return nil }\n```\n\n**File:** `pkg/backend/extensions/registry.go`\n\n```go\npackage extensions\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"sync\"\n\n    \"github.com/anthropics/ai-provider-kit/pkg/backendtypes\"\n)\n\ntype registry struct {\n    mu         sync.RWMutex\n    extensions map[string]Extension\n    order      []string\n}\n\nfunc NewRegistry() ExtensionRegistry {\n    return \u0026registry{\n        extensions: make(map[string]Extension),\n        order:      make([]string, 0),\n    }\n}\n\nfunc (r *registry) Register(ext Extension) error {\n    r.mu.Lock()\n    defer r.mu.Unlock()\n\n    name := ext.Name()\n    if _, exists := r.extensions[name]; exists {\n        return fmt.Errorf(\"extension %s already registered\", name)\n    }\n\n    r.extensions[name] = ext\n    r.order = append(r.order, name)\n    return nil\n}\n\nfunc (r *registry) Get(name string) (Extension, bool) {\n    r.mu.RLock()\n    defer r.mu.RUnlock()\n    ext, ok := r.extensions[name]\n    return ext, ok\n}\n\nfunc (r *registry) List() []Extension {\n    r.mu.RLock()\n    defer r.mu.RUnlock()\n\n    result := make([]Extension, 0, len(r.extensions))\n    for _, name := range r.order {\n        result = append(result, r.extensions[name])\n    }\n    return result\n}\n\nfunc (r *registry) Initialize(configs map[string]backendtypes.ExtensionConfig) error {\n    r.mu.RLock()\n    defer r.mu.RUnlock()\n\n    sorted, err := r.topologicalSort()\n    if err != nil {\n        return fmt.Errorf(\"dependency resolution failed: %w\", err)\n    }\n\n    for _, name := range sorted {\n        ext := r.extensions[name]\n        cfg, ok := configs[name]\n        if !ok || !cfg.Enabled {\n            continue\n        }\n        if err := ext.Initialize(cfg.Config); err != nil {\n            return fmt.Errorf(\"failed to initialize extension %s: %w\", name, err)\n        }\n    }\n    return nil\n}\n\nfunc (r *registry) Shutdown(ctx context.Context) error {\n    r.mu.RLock()\n    defer r.mu.RUnlock()\n\n    for i := len(r.order) - 1; i \u003e= 0; i-- {\n        name := r.order[i]\n        if err := r.extensions[name].Shutdown(ctx); err != nil {\n            return fmt.Errorf(\"failed to shutdown extension %s: %w\", name, err)\n        }\n    }\n    return nil\n}\n\nfunc (r *registry) topologicalSort() ([]string, error) {\n    // Topological sort implementation for dependency ordering\n    visited := make(map[string]bool)\n    result := make([]string, 0, len(r.extensions))\n\n    var visit func(name string) error\n    visit = func(name string) error {\n        if visited[name] {\n            return nil\n        }\n        visited[name] = true\n\n        ext, ok := r.extensions[name]\n        if !ok {\n            return nil\n        }\n\n        for _, dep := range ext.Dependencies() {\n            if err := visit(dep); err != nil {\n                return err\n            }\n        }\n\n        result = append(result, name)\n        return nil\n    }\n\n    for _, name := range r.order {\n        if err := visit(name); err != nil {\n            return nil, err\n        }\n    }\n\n    return result, nil\n}\n```\n\n**Acceptance Criteria:**\n- [ ] Extension interface defined with all lifecycle methods\n- [ ] BaseExtension provides sensible defaults\n- [ ] Registry handles registration and lifecycle\n- [ ] Topological sort for dependency ordering\n- [ ] Unit tests for registry operations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:21.838118915Z","updated_at":"2025-11-29T02:16:11.720297848Z","closed_at":"2025-11-29T02:16:11.720297848Z","dependencies":[{"issue_id":"workspace-fc4","depends_on_id":"workspace-30d","type":"blocks","created_at":"2025-11-29T02:00:38.076997299Z","created_by":"daemon"}]}
{"id":"workspace-fim","title":"OAuth runtime token injection not supported","description":"Providers do not support runtime OAuth token injection. Tokens can only be set at provider creation time, preventing:\n1. Dynamic token refresh when tokens expire\n2. Token acquisition after server startup\n3. Runtime switching between API key and OAuth authentication\n\n## Current Problem\nAuthHelper's OAuthManager and KeyManager are set at provider creation time and cannot be updated afterward. When Cortex's BeforeGenerate hook sets req.Metadata[\"oauth_token\"], the provider ignores it because AuthHelper checks its internal managers (both nil for OAuth-only providers).\n\n## Proposed Solutions (pick one)\n\n### Option 1: AuthHelper Runtime Update (Preferred)\nAdd methods to AuthHelper: SetOAuthToken(token), SetAPIKey(key), SetOAuthManager(manager)\n\n### Option 2: Request-Level Auth Override\nAdd AuthOverride field to GenerateOptions struct\n\n### Option 3: Provider Auth Callback\nAllow providers to accept a callback (AuthProvider interface) for dynamic auth\n\n### Option 4: Context-Based Auth\nPass auth through context using context.WithValue()\n\n## Impact\n- Users must restart after OAuth flows\n- Token refresh doesn't work (tokens expire after 1-8 hours)\n- Cannot switch between API key and OAuth without restart\n- Multi-credential rotation doesn't work\n\nAffects: Anthropic, Gemini, OpenAI, Qwen, and all AuthHelper-based providers","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-30T08:33:56.512090266Z","updated_at":"2025-11-30T08:41:54.63885466Z","closed_at":"2025-11-30T08:41:54.63885466Z"}
{"id":"workspace-g0w","title":"Fix race condition in TestConcurrentAccess","description":"Race detected in pkg/keymanager. The test TestConcurrentAccess/Concurrent_ExecuteWithFailover has a data race that needs to be fixed.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T10:49:45.007002336Z","updated_at":"2025-11-29T11:03:22.632633415Z","closed_at":"2025-11-29T11:03:22.632633415Z"}
{"id":"workspace-g8q","title":"Implement DefaultMetricsCollector","description":"Implement the concrete MetricsCollector that all providers will use.\n\n## Requirements\n- Implement MetricsCollector interface from workspace-7y2\n- Thread-safe using sync.RWMutex + atomic operations\n- Efficient histogram implementation for percentiles (P50, P95, P99)\n- Rolling window support for time-based aggregations\n- Configurable buffer size for event channel\n- Memory-efficient (avoid unbounded growth)\n\n## Implementation Details\n- Use circular buffer for latency samples (configurable size, default 1000)\n- Event channel with configurable buffer (default 100, drop oldest on overflow)\n- Per-provider and per-model metric maps with RWMutex\n- Atomic counters for hot path (request counts)\n- Snapshot creates deep copy to avoid lock contention\n\n## Location\n- pkg/metrics/collector.go (new package)\n- pkg/metrics/snapshot.go\n- pkg/metrics/events.go\n- pkg/metrics/hooks.go","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T16:55:11.188416697Z","updated_at":"2025-11-29T17:19:27.381030931Z","closed_at":"2025-11-29T17:19:27.381030931Z","dependencies":[{"issue_id":"workspace-g8q","depends_on_id":"workspace-7y2","type":"blocks","created_at":"2025-11-29T16:55:36.204572712Z","created_by":"daemon"},{"issue_id":"workspace-g8q","depends_on_id":"workspace-kgh","type":"blocks","created_at":"2025-11-29T16:56:31.362530825Z","created_by":"daemon"}]}
{"id":"workspace-gtt","title":"Extract rate limit handling to middleware/decorator pattern","description":"Same ParseAndUpdateRateLimits() call repeated 4+ times per provider (e.g., anthropic.go:672, 767, 1104, 1163). Abstract to middleware or decorator pattern with single TrackResponse() call. Estimated savings: 50-100 LOC.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T19:27:30.855543876Z","updated_at":"2025-11-29T19:55:38.74840703Z","closed_at":"2025-11-29T19:55:38.74840703Z","dependencies":[{"issue_id":"workspace-gtt","depends_on_id":"workspace-tb7","type":"blocks","created_at":"2025-11-29T19:28:08.341370194Z","created_by":"daemon"}]}
{"id":"workspace-h8i","title":"Centralize model cache TTL configuration","description":"Magic duration values scattered throughout providers: 6h (Anthropic), 24h (OpenAI), 2h (Gemini). Create ModelCacheTTLRegistry to centralize TTL management and make values configurable.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T19:27:31.920719306Z","updated_at":"2025-11-29T19:46:46.375369092Z","closed_at":"2025-11-29T19:46:46.375369092Z"}
{"id":"workspace-hge","title":"Fix race condition in TestOAuthKeyManager_WebhookIntegration","description":"Race detected during test execution in pkg/oauthmanager. The test TestOAuthKeyManager_WebhookIntegration has a data race that needs to be fixed with proper synchronization.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T10:49:43.395322004Z","updated_at":"2025-11-29T11:03:22.607450983Z","closed_at":"2025-11-29T11:03:22.607450983Z"}
{"id":"workspace-k7e","title":"Tests: pkg/providers/virtual/fallback (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:56:19.420463868Z","updated_at":"2025-11-29T10:05:55.911545242Z","closed_at":"2025-11-29T10:05:55.911545242Z"}
{"id":"workspace-k7u","title":"Fix errcheck in common provider tests","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:22:59.530812168Z","updated_at":"2025-11-29T11:27:13.980047278Z","closed_at":"2025-11-29T11:27:13.980047278Z"}
{"id":"workspace-kgh","title":"Define MetricEvent types for all provider operations","description":"Define the concrete event types that flow through the MetricsCollector event channel.\n\n## Event Types to Define\n\n### Request Lifecycle\n- RequestStartEvent: provider, model, requestID, timestamp, estimated input tokens\n- RequestCompleteEvent: latency, TTFT, input/output tokens, finish reason, cache hit\n- RequestErrorEvent: latency, error type, error code, retryable flag\n\n### Streaming\n- StreamStartEvent: provider, model, requestID\n- StreamChunkEvent: chunk index, tokens in chunk, time since start/last\n- StreamCompleteEvent: total chunks, total tokens, duration, tokens/sec, interruptions\n\n### Provider Health\n- HealthCheckEvent: provider, success, latency, status code\n- RateLimitEvent: provider, retry after, limit type, current usage, limit\n- CircuitStateEvent: provider, previous state, new state, failure/success counts\n\n### Virtual Provider\n- ProviderSwitchEvent: from, to, reason (failure/timeout/race_winner), attempt number\n- RaceCompleteEvent: winner, all latencies, participants\n\n## Design Notes\n- All events embed common fields (Type, Timestamp, Provider, Model, RequestID)\n- Use MetricEventData interface for type-specific data\n- Events are immutable once created","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T16:55:24.629111838Z","updated_at":"2025-11-29T17:10:38.549534102Z","closed_at":"2025-11-29T17:10:38.549534102Z","dependencies":[{"issue_id":"workspace-kgh","depends_on_id":"workspace-7y2","type":"blocks","created_at":"2025-11-29T16:55:36.213812944Z","created_by":"daemon"}]}
{"id":"workspace-ksq","title":"APK 1.2: Define Backend Configuration Types","description":"#### Task 1.2: Define Backend Configuration Types\n**Priority:** P0 - Blocking\n**Estimated Effort:** 4 hours\n\n**File:** `pkg/backendtypes/config.go`\n\n```go\npackage backendtypes\n\nimport (\n    \"time\"\n    \"github.com/anthropics/ai-provider-kit/pkg/types\"\n)\n\n// BackendConfig defines the configuration for the backend server\ntype BackendConfig struct {\n    Server     ServerConfig                      `yaml:\"server\"`\n    Auth       AuthConfig                        `yaml:\"auth\"`\n    Logging    LoggingConfig                     `yaml:\"logging\"`\n    CORS       CORSConfig                        `yaml:\"cors\"`\n    Providers  map[string]*types.ProviderConfig  `yaml:\"providers\"`\n    Extensions map[string]ExtensionConfig        `yaml:\"extensions\"`\n}\n\ntype ServerConfig struct {\n    Host            string        `yaml:\"host\"`\n    Port            int           `yaml:\"port\"`\n    Version         string        `yaml:\"version\"`\n    ReadTimeout     time.Duration `yaml:\"read_timeout\"`\n    WriteTimeout    time.Duration `yaml:\"write_timeout\"`\n    ShutdownTimeout time.Duration `yaml:\"shutdown_timeout\"`\n}\n\ntype AuthConfig struct {\n    Enabled     bool     `yaml:\"enabled\"`\n    APIPassword string   `yaml:\"api_password\"`\n    APIKeyEnv   string   `yaml:\"api_key_env\"`\n    PublicPaths []string `yaml:\"public_paths\"`\n}\n\ntype LoggingConfig struct {\n    Level  string `yaml:\"level\"`\n    Format string `yaml:\"format\"` // \"json\" or \"text\"\n}\n\ntype CORSConfig struct {\n    Enabled        bool     `yaml:\"enabled\"`\n    AllowedOrigins []string `yaml:\"allowed_origins\"`\n    AllowedMethods []string `yaml:\"allowed_methods\"`\n    AllowedHeaders []string `yaml:\"allowed_headers\"`\n}\n\ntype ExtensionConfig struct {\n    Enabled bool                   `yaml:\"enabled\"`\n    Config  map[string]interface{} `yaml:\"config\"`\n}\n```\n\n**Acceptance Criteria:**\n- [ ] All configuration types defined\n- [ ] YAML tags for serialization\n- [ ] Default values documented\n- [ ] Unit tests for config validation","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:15.445620167Z","updated_at":"2025-11-29T02:16:07.263047024Z","closed_at":"2025-11-29T02:16:07.263047024Z","dependencies":[{"issue_id":"workspace-ksq","depends_on_id":"workspace-30d","type":"blocks","created_at":"2025-11-29T02:00:38.024479113Z","created_by":"daemon"}]}
{"id":"workspace-ky4","title":"Implement ProviderFactory to eliminate initialization boilerplate","description":"Every provider repeats ~50 lines of setup: ConfigHelper creation, MergeWithDefaults(), ExtractTimeout(), ExtractBaseURL(), AuthHelper creation, SetupAPIKeys(), SetupOAuth(). Create ProviderFactory with template method pattern. Estimated savings: 300-400 LOC across 6 providers.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T19:27:29.201286731Z","updated_at":"2025-11-29T19:55:37.162527571Z","closed_at":"2025-11-29T19:55:37.162527571Z","dependencies":[{"issue_id":"workspace-ky4","depends_on_id":"workspace-tb7","type":"blocks","created_at":"2025-11-29T19:28:08.317871042Z","created_by":"daemon"}]}
{"id":"workspace-l46","title":"APK 3.1: Add OAuth Handler","description":"#### Task 3.1: Add OAuth Handler\n**Priority:** P1 - High\n**Estimated Effort:** 8 hours\n\n**Acceptance Criteria:**\n- [ ] OAuth initiation endpoint\n- [ ] OAuth callback endpoint\n- [ ] Token refresh endpoint\n- [ ] Integration with oauthmanager","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:45.357392527Z","updated_at":"2025-11-29T02:38:25.581619445Z","closed_at":"2025-11-29T02:38:25.581619445Z","dependencies":[{"issue_id":"workspace-l46","depends_on_id":"workspace-sqx","type":"blocks","created_at":"2025-11-29T02:00:40.330293091Z","created_by":"daemon"}]}
{"id":"workspace-lrc","title":"Fix virtual provider metrics (racing/fallback/loadbalance)","description":"Virtual providers currently return empty metrics from GetMetrics(). They should aggregate metrics from underlying providers and add their own operational metrics.\n\n## Current Problem\n```go\n// In stubs.go for all virtual providers:\nfunc (r *RacingProvider) GetMetrics() types.ProviderMetrics {\n    return types.ProviderMetrics{} // Empty!\n}\n```\n\n## Required Metrics\n\n### Racing Provider\n- Race count, win distribution by provider\n- Average race latency vs winner latency (shows benefit)\n- Timeout/failure counts\n- Grace period utilization stats\n\n### Fallback Provider  \n- Fallback trigger count\n- Success rate by position in chain\n- Average attempts before success\n- Which providers are failing (and why)\n\n### LoadBalance Provider\n- Request distribution across providers\n- Per-provider success rates\n- Rebalancing events (if health-based)\n\n## Implementation\n- Each virtual provider should:\n  1. Aggregate GetMetrics() from child providers\n  2. Add its own operational metrics\n  3. Emit ProviderSwitchEvent on fallback/race completion\n- Consider: should virtual providers have their own MetricsCollector or share global?","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T16:56:01.151464086Z","updated_at":"2025-11-29T17:40:02.987929489Z","closed_at":"2025-11-29T17:40:02.987929489Z","dependencies":[{"issue_id":"workspace-lrc","depends_on_id":"workspace-ufv","type":"blocks","created_at":"2025-11-29T16:56:31.39929784Z","created_by":"daemon"}]}
{"id":"workspace-lrf","title":"Tests: pkg/providers/cerebras (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:57:44.536195541Z","updated_at":"2025-11-29T10:35:45.461998795Z","closed_at":"2025-11-29T10:35:45.461998795Z"}
{"id":"workspace-lv0","title":"Define ContentPart and MediaSource types for multimodal support","description":"## Overview\n\nAdd core type definitions for multimodal content support. These types enable consumers to pass images, documents, audio, and other media through ai-provider-kit.\n\n## Types to Add\n\n```go\n// ContentPart represents a single part of message content\ntype ContentPart struct {\n    Type string `json:\"type\"` // \"text\", \"image\", \"document\", \"audio\", \"tool_use\", \"tool_result\", \"thinking\"\n    \n    // Text content\n    Text string `json:\"text,omitempty\"`\n    \n    // Media content (images, documents, audio)\n    Source *MediaSource `json:\"source,omitempty\"`\n    \n    // Tool use (model calling a tool)\n    ID    string                 `json:\"id,omitempty\"`\n    Name  string                 `json:\"name,omitempty\"`\n    Input map[string]interface{} `json:\"input,omitempty\"`\n    \n    // Tool result (response to tool call)\n    ToolUseID string      `json:\"tool_use_id,omitempty\"`\n    Content   interface{} `json:\"content,omitempty\"` // string or []ContentPart\n    \n    // Extended thinking\n    Thinking string `json:\"thinking,omitempty\"`\n    \n    // Escape hatch for future/provider-specific types\n    Extra map[string]interface{} `json:\"extra,omitempty\"`\n}\n\n// MediaSource represents the source of media content\ntype MediaSource struct {\n    Type      string `json:\"type\"`       // \"base64\", \"url\"\n    MediaType string `json:\"media_type\"` // MIME type: \"image/png\", \"application/pdf\", \"audio/wav\"\n    Data      string `json:\"data,omitempty\"`\n    URL       string `json:\"url,omitempty\"`\n}\n```\n\n## Design Principles\n\n1. `Type` field drives interpretation - consumers check type to know which fields matter\n2. `MediaSource` is reusable - same structure for images, docs, audio\n3. `Extra` map - escape hatch for provider-specific or future fields\n4. `Content` as interface{} - tool results can be string or nested content parts\n\n## File Location\n\n`pkg/types/content.go` (new file)","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-30T16:04:37.464823025Z","updated_at":"2025-11-30T16:04:37.464823025Z"}
{"id":"workspace-msj","title":"Tests: pkg/providers/base (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:57:45.849235695Z","updated_at":"2025-11-29T10:35:45.404018955Z","closed_at":"2025-11-29T10:35:45.404018955Z"}
{"id":"workspace-mso","title":"Anthropic and Gemini streaming paths missing context token check","description":"Anthropic and Gemini streaming paths bypass ExecuteWithAuthMessage and directly check OAuthManager, missing context-injected tokens.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-30T14:53:40.819734033Z","updated_at":"2025-11-30T14:55:13.793032856Z","closed_at":"2025-11-30T14:55:13.793032856Z"}
{"id":"workspace-nx9","title":"Fix errcheck in virtual provider tests","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:22:59.516889114Z","updated_at":"2025-11-29T11:27:13.97021332Z","closed_at":"2025-11-29T11:27:13.97021332Z"}
{"id":"workspace-of4","title":"Tests: pkg/backend/middleware (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:56:18.565795724Z","updated_at":"2025-11-29T10:05:55.871033576Z","closed_at":"2025-11-29T10:05:55.871033576Z"}
{"id":"workspace-oox","title":"Tests: pkg/providers/openrouter (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:57:44.856433293Z","updated_at":"2025-11-29T10:35:45.447405447Z","closed_at":"2025-11-29T10:35:45.447405447Z"}
{"id":"workspace-oun","title":"Fix errcheck: unchecked error returns in metrics code","description":"golangci-lint errcheck failures:\n- collector.RecordEvent return values not checked (many locations)\n- collector.Close return values not checked in tests\n- wrapper.Close/Next return values not checked in tests\n\nFiles affected:\n- pkg/metrics/stream_wrapper.go\n- pkg/metrics/example_test.go\n- pkg/providers/virtual/racing/provider.go\n- pkg/providers/virtual/fallback/provider.go\n- pkg/providers/virtual/loadbalance/provider.go\n- pkg/providers/base/base.go\n- Various test files","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T18:04:38.414083711Z","updated_at":"2025-11-29T18:12:52.902808829Z","closed_at":"2025-11-29T18:12:52.902808829Z"}
{"id":"workspace-p3r","title":"Qwen OAuth tokens incompatible with dashscope.aliyuncs.com default URL","description":"## The Problem\n\nThe `confighelper.go` has the wrong default URL for OAuth-based Qwen authentication.\n\n- OAuth flow through `chat.qwen.ai` produces tokens that work with `portal.qwen.ai`\n- But `confighelper.go` defaults to `dashscope.aliyuncs.com` which uses a different auth system\n\n## Evidence\n\nFrom logs:\n```\nProvider qwen - POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions\n```\n\n## Root Cause\n\n`InitializeProviderComponents` (line 68) extracts baseURL from `configHelper.ExtractBaseURL()` which returns `https://dashscope.aliyuncs.com/compatible-mode/v1` for Qwen (from `confighelper.go` line 97).\n\nThe Qwen provider's `GenerateChatCompletion` gets the base URL from `providerConfig.BaseURL` which is set from `InitializeProviderComponents`.\n\n## The Fix\n\n`confighelper.go` should:\n1. Use `portal.qwen.ai` as default when OAuth is configured\n2. Use `dashscope.aliyuncs.com` as default when API key is configured\n\nOr alternatively, the Qwen provider should detect OAuth auth and override the URL to `portal.qwen.ai`.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-30T15:15:15.021672933Z","updated_at":"2025-11-30T15:18:10.946293279Z","closed_at":"2025-11-30T15:18:10.946293279Z"}
{"id":"workspace-p7z","title":"Extract shared ModelMetadataRegistry for provider model handling","description":"Each provider reimplements enrichModels(), getStaticFallback(), and model metadata handling. Extract to shared ModelMetadataRegistry in pkg/providers/common/models.go. Affects: anthropic, openai, gemini, cerebras, qwen, openrouter. Estimated savings: 200-300 LOC.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T19:27:27.748342644Z","updated_at":"2025-11-29T19:46:45.601953497Z","closed_at":"2025-11-29T19:46:45.601953497Z"}
{"id":"workspace-pef","title":"Tests: pkg/types (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:57:43.28412168Z","updated_at":"2025-11-29T10:17:28.029940567Z","closed_at":"2025-11-29T10:17:28.029940567Z"}
{"id":"workspace-qbp","title":"Fix duplicate code in server_test.go","description":"golangci-lint dupl: pkg/backend/server_test.go:192-243 lines are duplicate of lines 246-295. Refactor to eliminate duplication.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T10:49:50.516020426Z","updated_at":"2025-11-29T10:58:15.665134777Z","closed_at":"2025-11-29T10:58:15.665134777Z"}
{"id":"workspace-raq","title":"Fix unused parseOAuthRequest function","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:32:03.058644437Z","updated_at":"2025-11-29T11:35:54.980394086Z","closed_at":"2025-11-29T11:35:54.980394086Z"}
{"id":"workspace-sgf","title":"Remove legacy dual metrics systems","description":"Clean up the old metrics code after MetricsCollector is fully integrated.\n\n## Code to Remove\n\n### pkg/providers/common/metrics.go\n- ProviderMetrics struct (replaced by MetricsCollector)\n- MetricsSnapshot struct (replaced by types.MetricsSnapshot)\n- All Record* methods (moved to collector)\n- This file can be deleted entirely\n\n### pkg/providers/base/base.go\n- metrics field from BaseProvider struct\n- IncrementRequestCount, RecordSuccess, RecordError methods\n- UpdateHealthStatus, UpdateHealthStatusResponseTime methods\n- Keep GetMetrics() but derive from collector\n\n### pkg/types/metrics.go\n- Review and consolidate with new types\n- Remove redundant RouterHealthStatus, RouterMetrics if unused\n- Keep types that are part of public API\n\n## Verification\n- All tests still pass\n- No references to removed types\n- Consumers (Cortex, VelocityCode) use new MetricsCollector API\n\n## This is the final cleanup after:\n1. MetricsCollector interface designed\n2. DefaultMetricsCollector implemented  \n3. All providers integrated\n4. Virtual providers fixed","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T16:56:22.673647085Z","updated_at":"2025-11-29T17:40:50.881013992Z","closed_at":"2025-11-29T17:40:50.881013992Z","dependencies":[{"issue_id":"workspace-sgf","depends_on_id":"workspace-ufv","type":"blocks","created_at":"2025-11-29T16:56:31.410094717Z","created_by":"daemon"},{"issue_id":"workspace-sgf","depends_on_id":"workspace-lrc","type":"blocks","created_at":"2025-11-29T16:56:31.42169223Z","created_by":"daemon"},{"issue_id":"workspace-sgf","depends_on_id":"workspace-wtn","type":"blocks","created_at":"2025-11-29T16:56:31.432310113Z","created_by":"daemon"},{"issue_id":"workspace-sgf","depends_on_id":"workspace-cfb","type":"blocks","created_at":"2025-11-29T16:56:51.73922411Z","created_by":"daemon"}]}
{"id":"workspace-sih","title":"Fix race conditions in HealthChecker tests","description":"Race detected in pkg/providers/common. Tests TestHealthChecker_Start_Stop and TestHealthChecker_ThreadSafety have data races that need proper synchronization.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T10:49:44.174345526Z","updated_at":"2025-11-29T11:03:22.621308383Z","closed_at":"2025-11-29T11:03:22.621308383Z"}
{"id":"workspace-spr","title":"Create pkg/testutil package with shared mocks and fixtures","description":"## Summary\nCreate a centralized testutil package to eliminate duplicated mock implementations and test fixtures across 89 test files.\n\n## Current Duplication\n- `mockProvider` duplicated in 4+ files (~90 lines each)\n- `mockStream` duplicated in 4+ files (~50 lines each)\n- `mockExtension` duplicated in 2+ files\n- Test data (API keys, model IDs, URLs) hardcoded in 30+ files\n\n## Proposed Structure\n```\npkg/testutil/\n├── mocks.go           # ConfigurableMockProvider, MockStream, etc.\n├── fixtures.go        # TestFixtures with configs, models, messages\n├── assertions.go      # Common assertion helpers\n├── context.go         # Context management helpers\n└── testdata/          # JSON fixtures\n```\n\n## Impact\n- Reduces ~600+ lines of duplicate mock code\n- Single source of truth for test data\n- Easier to maintain when APIs change\n\n## Complexity\nMedium - requires updating 8+ test files to use shared mocks","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T12:57:16.84924666Z","updated_at":"2025-11-29T13:09:52.976716067Z","closed_at":"2025-11-29T13:09:52.976716067Z"}
{"id":"workspace-sqx","title":"APK 2.5: Implement Backend Server","description":"#### Task 2.5: Implement Backend Server\n**Priority:** P0 - Blocking\n**Estimated Effort:** 8 hours\n\n**File:** `pkg/backend/server.go`\n\n**Features:**\n- Server initialization with config\n- Provider initialization (including virtual providers)\n- Extension initialization\n- Middleware application\n- Graceful shutdown\n- Integration tests\n\n**Acceptance Criteria:**\n- [ ] Server initialization with config\n- [ ] Provider initialization (including virtual providers)\n- [ ] Extension initialization\n- [ ] Middleware application\n- [ ] Graceful shutdown\n- [ ] Integration tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:44.370648254Z","updated_at":"2025-11-29T02:27:36.541553334Z","closed_at":"2025-11-29T02:27:36.541553334Z","dependencies":[{"issue_id":"workspace-sqx","depends_on_id":"workspace-1nh","type":"blocks","created_at":"2025-11-29T02:00:39.268538144Z","created_by":"daemon"},{"issue_id":"workspace-sqx","depends_on_id":"workspace-2xd","type":"blocks","created_at":"2025-11-29T02:00:39.279677886Z","created_by":"daemon"},{"issue_id":"workspace-sqx","depends_on_id":"workspace-1x4","type":"blocks","created_at":"2025-11-29T02:00:39.289793681Z","created_by":"daemon"},{"issue_id":"workspace-sqx","depends_on_id":"workspace-2fy","type":"blocks","created_at":"2025-11-29T02:00:39.300876577Z","created_by":"daemon"}]}
{"id":"workspace-st4","title":"Fix code quality: complexity, staticcheck, unparam issues","description":"golangci-lint code quality failures:\n- gocyclo: MetricFilter.Matches has cyclomatic complexity 24 (\u003e20)\n- gocritic: Use += instead of = + \n- staticcheck: Empty branch in collector.go\n- unparam: Unused parameters in tests and stream_wrapper.go\n- dupl: Duplicate code in racing provider\n\nFiles affected:\n- pkg/types/metrics_collector.go (Matches function)\n- pkg/metrics/stream_wrapper.go\n- pkg/metrics/collector.go\n- pkg/metrics/cost_test.go\n- pkg/providers/base/base_metrics_test.go\n- pkg/providers/virtual/racing/provider.go","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T18:04:38.440317297Z","updated_at":"2025-11-29T18:12:54.470973052Z","closed_at":"2025-11-29T18:12:54.470973052Z"}
{"id":"workspace-t42","title":"Remove dead code: unused utilities and functions","description":"## Summary\n\nCode exploration found several unused functions and utilities kept around \"just in case\". This adds maintenance burden without value.\n\n## High Priority - Remove\n\n### 1. `/workspace/pkg/providers/common/cleanup.go` (and test)\n- `CleanCodeResponse()` - no longer called after workspace-2ru\n- Remove entire file\n\n### 2. `/workspace/pkg/providers/common/language.go` (and test)\n- `DetectLanguage()` - never called anywhere\n- Remove entire file\n\n### 3. `/workspace/pkg/providers/common/fileutils.go`\n- `ReadFileContent()` - never called\n- `FilterContextFiles()` - never called\n- **Keep** `ReadConfigFile()` - used by Gemini provider\n\n### 4. `/workspace/pkg/http/utils.go`\n- `IsRetryableError()` - only used in tests, not production\n- `ProcessResponse()` - never called, providers handle directly\n- `ProcessJSONResponse()` - never called\n- `ParseAPIError()` - never called\n- `NewStreamingResponse()` - only used in tests\n\n## Medium Priority - Review\n\n### `/workspace/pkg/providers/common/metrics.go`\n- `GetMetricsForProvider()` - never called\n- `GetTopModels()` - never called  \n- `GetErrorSummary()` - never called\n- These might be intended for future monitoring - decide whether to keep or remove\n\n## Keep As-Is\n\n- `/workspace/pkg/dev/` - intentionally build-tag gated for development use\n\n## Estimated Impact\n- ~250-300 lines of dead code removed\n- 2 files completely removed (cleanup.go, language.go)\n- No breaking changes to production code","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T15:38:23.555266182Z","updated_at":"2025-11-29T15:50:17.455054876Z","closed_at":"2025-11-29T15:50:17.455054876Z"}
{"id":"workspace-taz","title":"Tests: pkg/backend/extensions (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:56:18.770071878Z","updated_at":"2025-11-29T10:05:55.881078996Z","closed_at":"2025-11-29T10:05:55.881078996Z"}
{"id":"workspace-tb7","title":"Create shared RequestHandler and ResponseParser interfaces","description":"Repeated request/response patterns across all providers: request preparation (marshaling, headers), response parsing (unmarshal, error checking), OAuth/API key routing. Create RequestHandler and ResponseParser interfaces in pkg/providers/base/. Estimated savings: 300-500 LOC.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T19:27:28.484350435Z","updated_at":"2025-11-29T19:46:44.459838445Z","closed_at":"2025-11-29T19:46:44.459838445Z"}
{"id":"workspace-tet","title":"Fix errcheck in backend extensions test","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:22:59.472181982Z","updated_at":"2025-11-29T11:27:13.936015851Z","closed_at":"2025-11-29T11:27:13.936015851Z"}
{"id":"workspace-tia","title":"Qwen provider doesn't support context-injected OAuth tokens","description":"## The Problem\n\n`ExecuteWithAuth` only returns `(string, *types.Usage, error)` - it loses tool call information.\n\n### Current State by Provider\n\n**Qwen**: Bypassed `ExecuteWithAuth` entirely to preserve tool calls:\n```go\nswitch {\ncase p.authHelper.OAuthManager != nil:\n    responseMessage, usage, _, err = p.executeWithOAuthMessage(ctx, options)\ncase p.authHelper.KeyManager != nil:\n    responseMessage, usage, _, err = p.executeWithAPIKeyMessage(ctx, options)\n}\n```\n- ✅ Preserves tool calls\n- ❌ Doesn't check context-injected OAuth tokens\n\n**Anthropic/Gemini**: Use `ExecuteWithAuth` but lose tool calls:\n```go\n// From anthropic.go lines 470-472:\n// Note: For now we return simple text responses.\n// Tool call support would require changing the entire flow to return\n// the full response instead of just text.\n```\n- ✅ Checks context-injected OAuth tokens\n- ❌ Loses tool call information in non-streaming\n\n## The Proper Fix\n\nAdd `ExecuteWithAuthMessage` to AuthHelper that returns full ChatMessage:\n\n```go\nfunc (h *AuthHelper) ExecuteWithAuthMessage(\n    ctx context.Context,\n    options types.GenerateOptions,\n    oauthOperation func(context.Context, *types.OAuthCredentialSet) (types.ChatMessage, *types.Usage, error),\n    apiKeyOperation func(context.Context, string) (types.ChatMessage, *types.Usage, error),\n) (types.ChatMessage, *types.Usage, error) {\n    // Check for context-injected OAuth token first\n    if contextToken := GetOAuthToken(ctx); contextToken != \"\" {\n        cred := \u0026types.OAuthCredentialSet{AccessToken: contextToken}\n        return oauthOperation(ctx, cred)\n    }\n    \n    // Rest of failover logic...\n}\n```\n\n## Implementation Steps\n\n1. Add `ExecuteWithAuthMessage` to `pkg/providers/common/authhelpers.go`\n2. Update Qwen to use `ExecuteWithAuthMessage` (fixes context token issue)\n3. Update Anthropic to use `ExecuteWithAuthMessage` (fixes tool call loss)\n4. Update Gemini to use `ExecuteWithAuthMessage` (fixes tool call loss)\n5. Remove the old workarounds and comments about \"simple text responses\"\n6. Keep `ExecuteWithAuth` for backwards compatibility (GetModels still uses it)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-30T09:54:55.735604675Z","updated_at":"2025-11-30T10:08:00.437559954Z","closed_at":"2025-11-30T10:08:00.437559954Z"}
{"id":"workspace-tk5","title":"Extract shared BackoffCalculator for retry logic","description":"## Summary\nExtract duplicated exponential backoff calculation logic into a shared utility.\n\n## Current Duplication\n- `pkg/http/client.go`: RetryHandler.calculateDelay() - bit shifting approach\n- `pkg/auth/apikey.go`: APIKeyManagerImpl.calculateBackoff() - iteration approach\n\nBoth implement exponential backoff with jitter but differently.\n\n## Proposed Solution\nCreate shared backoff utility:\n```go\n// pkg/http/backoff.go or pkg/backoff/backoff.go\ntype BackoffStrategy interface {\n    Calculate(attempt int) time.Duration\n}\n\ntype ExponentialBackoff struct {\n    BaseDelay  time.Duration\n    MaxDelay   time.Duration\n    Multiplier float64\n    Jitter     bool\n}\n\nfunc (eb *ExponentialBackoff) Calculate(attempt int) time.Duration\n```\n\n## Complexity\nMedium - requires creating shared utility and updating both call sites","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T12:57:19.550932759Z","updated_at":"2025-11-29T13:05:42.970276564Z","closed_at":"2025-11-29T13:05:42.970276564Z"}
{"id":"workspace-u8x","title":"Implement Gemini provider multimodal conversion","description":"## Overview\n\nUpdate Gemini provider to convert ContentPart to Gemini's native format.\n\n## Gemini Native Format\n\n```json\n{\n  \"contents\": [{\n    \"role\": \"user\",\n    \"parts\": [\n      {\"text\": \"What's in this image?\"},\n      {\"inlineData\": {\"mimeType\": \"image/png\", \"data\": \"base64...\"}}\n    ]\n  }]\n}\n```\n\n## Supported Content Types\n\n- `text` → `{text: \"...\"}`\n- `image` (base64) → `{inlineData: {mimeType: \"...\", data: \"...\"}}`\n- `image` (url) → `{fileData: {mimeType: \"...\", fileUri: \"...\"}}` (for GCS URIs)\n- `tool_use` → `{functionCall: {name, args}}`\n- `tool_result` → `{functionResponse: {name, response}}`\n\n## Changes Required\n\n1. Update `prepareStandardRequest()` in `gemini.go`\n2. Handle `ChatMessage.Content` as string or []ContentPart\n3. Convert MediaSource to Gemini's inlineData/fileData format\n4. Map ContentPart types to Gemini Part structures\n\n## Notes\n\nGemini uses `inlineData` for base64 and `fileData` for URLs/URIs. Need to handle both.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-30T16:05:17.826771206Z","updated_at":"2025-11-30T16:05:17.826771206Z","dependencies":[{"issue_id":"workspace-u8x","depends_on_id":"workspace-3i4","type":"blocks","created_at":"2025-11-30T16:05:17.833945263Z","created_by":"daemon"}]}
{"id":"workspace-ufv","title":"Integrate providers with MetricsCollector","description":"Update all provider implementations to use the new centralized MetricsCollector instead of the fragmented metrics systems.\n\n## Current State\nTwo disconnected metrics systems:\n1. base.BaseProvider.metrics (types.ProviderMetrics) - used by providers\n2. common.ProviderMetrics - richer but standalone, used by initializer\n\n## Changes Required\n\n### Provider Base\n- Add MetricsCollector field to BaseProvider\n- Update RecordSuccess/RecordError to emit events to collector\n- Remove direct metrics struct manipulation\n\n### Each Provider Implementation\n- openai, anthropic, gemini, cerebras, qwen, etc.\n- Pass collector to provider on creation\n- Ensure all code paths emit appropriate events\n\n### Factory\n- Create/inject MetricsCollector when creating providers\n- Option to pass existing collector (for sharing across providers)\n\n## Migration Path\n- Keep GetMetrics() working but derive from collector snapshot\n- Deprecate direct metric field access\n- Eventually remove base.BaseProvider.metrics struct\n\n## Files to Modify\n- pkg/providers/base/base.go\n- pkg/providers/openai/openai.go\n- pkg/providers/anthropic/anthropic.go\n- pkg/providers/gemini/gemini.go\n- pkg/providers/cerebras/cerebras.go\n- pkg/providers/qwen/qwen.go\n- pkg/factory/factory.go","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T16:56:11.60676972Z","updated_at":"2025-11-29T17:28:03.35373703Z","closed_at":"2025-11-29T17:28:03.35373703Z","dependencies":[{"issue_id":"workspace-ufv","depends_on_id":"workspace-g8q","type":"blocks","created_at":"2025-11-29T16:56:31.387989818Z","created_by":"daemon"}]}
{"id":"workspace-ukq","title":"Tests: pkg/providers/virtual/racing (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:56:19.196634875Z","updated_at":"2025-11-29T10:05:55.901769243Z","closed_at":"2025-11-29T10:05:55.901769243Z"}
{"id":"workspace-uud","title":"APK 2.1: Implement Base Handler Utilities","description":"#### Task 2.1: Implement Base Handler Utilities\n**Priority:** P0 - Blocking\n**Estimated Effort:** 4 hours\n\n**File:** `pkg/backend/handlers/base.go`\n\n**Acceptance Criteria:**\n- [ ] SendSuccess, SendError, SendCreated methods\n- [ ] ParseJSON for request parsing\n- [ ] Consistent response formatting\n- [ ] Unit tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:40.896157798Z","updated_at":"2025-11-29T02:21:29.90604859Z","closed_at":"2025-11-29T02:21:29.90604859Z","dependencies":[{"issue_id":"workspace-uud","depends_on_id":"workspace-ksq","type":"blocks","created_at":"2025-11-29T02:00:39.20724421Z","created_by":"daemon"},{"issue_id":"workspace-uud","depends_on_id":"workspace-ezv","type":"blocks","created_at":"2025-11-29T02:00:39.21720205Z","created_by":"daemon"},{"issue_id":"workspace-uud","depends_on_id":"workspace-fc4","type":"blocks","created_at":"2025-11-29T02:00:39.226172251Z","created_by":"daemon"}]}
{"id":"workspace-v91","title":"Add ProviderInterceptor pattern for provider calls","description":"## Summary\nAdd an interceptor pattern that wraps provider calls, enabling cross-cutting concerns like caching, retries, circuit breakers, and fallbacks.\n\n## Motivation\nThe current hook-based system (BeforeGenerate/AfterGenerate) cannot:\n- Skip the provider call entirely (e.g., return cached response)\n- Implement retry logic around provider calls\n- Implement circuit breaker patterns\n- Handle fallback to alternate providers\n\n## Proposed Interface\n```go\ntype ProviderInterceptor interface {\n    Intercept(ctx context.Context, req GenerateRequest, next ProviderFunc) (*GenerateResponse, error)\n}\n\ntype ProviderFunc func(ctx context.Context, req GenerateRequest) (*GenerateResponse, error)\n```\n\n## Example Use Cases\n1. **Caching Interceptor** - Return cached response without calling provider\n2. **Retry Interceptor** - Retry failed calls with exponential backoff\n3. **Circuit Breaker** - Fail fast when provider is unhealthy\n4. **Fallback Interceptor** - Try alternate provider on failure\n5. **Timeout Interceptor** - Enforce request timeouts\n\n## Implementation Notes\n- Interceptors form a chain, each calling `next()` to proceed\n- Can be combined with existing hook system (hooks for observation, interceptors for control)\n- Should integrate with existing ExtensionRegistry or have separate InterceptorRegistry","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T12:20:11.4744441Z","updated_at":"2025-11-29T12:26:01.176170025Z","closed_at":"2025-11-29T12:26:01.176170025Z"}
{"id":"workspace-viy","title":"Tests: pkg/backend server (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:56:18.184809076Z","updated_at":"2025-11-29T10:05:55.845803873Z","closed_at":"2025-11-29T10:05:55.845803873Z"}
{"id":"workspace-vsp","title":"Add multimodal content unit tests","description":"## Overview\n\nAdd comprehensive tests for multimodal content handling.\n\n## Test Cases\n\n### Core Types\n- ContentPart serialization/deserialization\n- MediaSource with base64 vs URL\n- ChatMessage with string content (backwards compat)\n- ChatMessage with []ContentPart content\n- Helper methods (GetContentParts, GetTextContent, HasImages, etc.)\n\n### Provider Conversions\n- Anthropic: text, image (base64), image (url), document, tool_use, tool_result\n- OpenAI: text, image (base64 → data URL), image (url)\n- Gemini: text, image (inlineData), image (fileData)\n\n### Edge Cases\n- Empty content parts array\n- Mixed text and image content\n- Nested content in tool results\n- Unknown content types (should pass through via Extra)\n- Large base64 images\n\n### Integration Tests\n- Round-trip: ContentPart → Provider format → Response parsing\n- Mock server tests with multimodal requests\n\n## Files\n\n- `pkg/types/content_test.go` (new)\n- `pkg/providers/*/multimodal_test.go` (new for each provider)","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T16:05:29.242747852Z","updated_at":"2025-11-30T16:05:29.242747852Z","dependencies":[{"issue_id":"workspace-vsp","depends_on_id":"workspace-8zu","type":"blocks","created_at":"2025-11-30T16:05:29.24721382Z","created_by":"daemon"},{"issue_id":"workspace-vsp","depends_on_id":"workspace-8u7","type":"blocks","created_at":"2025-11-30T16:05:29.25029755Z","created_by":"daemon"},{"issue_id":"workspace-vsp","depends_on_id":"workspace-u8x","type":"blocks","created_at":"2025-11-30T16:05:29.253129811Z","created_by":"daemon"}]}
{"id":"workspace-w7s","title":"Fix errcheck in backend handlers","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:22:59.487666418Z","updated_at":"2025-11-29T11:27:13.947833007Z","closed_at":"2025-11-29T11:27:13.947833007Z"}
{"id":"workspace-wnh","title":"Add priority/ordering to extension execution","description":"## Summary\nAdd explicit priority control for extension execution order.\n\n## Motivation\nCurrently extensions execute in registration order, which:\n- Is implicit and easy to get wrong\n- Makes it hard to ensure security extensions run first\n- Doesn't allow extensions to declare \"run before/after X\"\n\n## Proposed Interface\n```go\ntype Extension interface {\n    // ... existing methods\n    Priority() int  // Lower number = runs first (0-1000 range suggested)\n}\n\n// Common priority constants\nconst (\n    PrioritySecurity   = 100  // Auth, validation\n    PriorityCache      = 200  // Caching checks\n    PriorityTransform  = 500  // Request/response transformation\n    PriorityLogging    = 900  // Logging, metrics\n)\n```\n\n## Alternative: Explicit Ordering\n```go\ntype Extension interface {\n    RunBefore() []string  // Extension names this should run before\n    RunAfter() []string   // Extension names this should run after\n}\n```\n\n## Implementation Notes\n- Default priority for BaseExtension: 500 (middle)\n- Registry sorts by priority before returning List()\n- Consider stable sort to preserve registration order for same priority\n- Add validation for circular \"run before/after\" dependencies","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T12:20:14.250137276Z","updated_at":"2025-11-29T12:25:34.063965553Z","closed_at":"2025-11-29T12:25:34.063965553Z"}
{"id":"workspace-wrs","title":"Extract common provider utilities (cleanCodeResponse, model metadata)","description":"## Summary\nExtract duplicated utility functions from individual providers to pkg/providers/common.\n\n## Duplicated Functions\n\n### 1. cleanCodeResponse() - 26 lines duplicated\n- `pkg/providers/anthropic/anthropic.go:797-813`\n- `pkg/providers/gemini/gemini.go:759-775`\n\n### 2. Model metadata functions - 100+ lines\n- isChatModel(), getDisplayName(), getMaxTokens(), supportsToolCalling()\n- Duplicated in openai, cerebras, anthropic providers\n\n## Proposed Solution\nAdd to `pkg/providers/common/`:\n```go\n// cleanup.go\nfunc CleanCodeResponse(content string) string\n\n// model_metadata.go\ntype ModelMetadata struct {\n    DisplayName         string\n    MaxTokens          int\n    SupportsStreaming  bool\n    SupportsToolCalling bool\n}\n\ntype ModelMetadataProvider interface {\n    GetMetadata(modelID string) ModelMetadata\n}\n```\n\n## Complexity\nLow-Medium - simple extraction, no behavioral changes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T12:57:20.796979179Z","updated_at":"2025-11-29T13:06:33.981399936Z","closed_at":"2025-11-29T13:06:33.981399936Z"}
{"id":"workspace-wtn","title":"Add streaming metrics (TTFT, tokens/sec)","description":"Add streaming-specific metrics that are critical for AI UX measurement.\n\n## Metrics to Track\n- TimeToFirstToken (TTFT): Duration from request start to first chunk received\n- TokensPerSecond: Output throughput during streaming\n- ChunksReceived: Total SSE/stream chunks\n- StreamDuration: Total time from first to last chunk\n- StreamInterruptions: Connection drops that recovered mid-stream\n- BackpressureEvents: When consumer is slower than producer\n\n## Implementation\n- Wrap ChatCompletionStream to intercept chunks\n- Record timing on first chunk (TTFT)\n- Track inter-chunk timing for throughput calculation\n- Emit StreamChunkEvent for each chunk\n- Emit StreamCompleteEvent with aggregates on close\n\n## Integration Points\n- Modify stream wrapper in provider implementations\n- Or create MetricsStreamWrapper that wraps any stream\n- Emit events to MetricsCollector\n\n## Why This Matters\n- TTFT is the most important UX metric for streaming AI\n- Users perceive latency based on first token, not total time\n- Throughput affects perceived responsiveness","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-29T16:55:47.655369505Z","updated_at":"2025-11-29T17:28:03.330653937Z","closed_at":"2025-11-29T17:28:03.330653937Z","dependencies":[{"issue_id":"workspace-wtn","depends_on_id":"workspace-g8q","type":"blocks","created_at":"2025-11-29T16:56:31.377576125Z","created_by":"daemon"}]}
{"id":"workspace-xdr","title":"Fix errcheck in http client test","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:22:59.502057716Z","updated_at":"2025-11-29T11:27:13.959136665Z","closed_at":"2025-11-29T11:27:13.959136665Z"}
{"id":"workspace-xzt","title":"APK 1.6: Implement Load Balance Virtual Provider","description":"#### Task 1.6: Implement Load Balance Virtual Provider\n**Priority:** P1 - High\n**Estimated Effort:** 4 hours\n\n**File:** `pkg/providers/virtual/loadbalance/provider.go`\n\n```go\npackage loadbalance\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"sync/atomic\"\n\n    \"github.com/anthropics/ai-provider-kit/pkg/types\"\n)\n\n// LoadBalanceProvider distributes requests across providers\ntype LoadBalanceProvider struct {\n    name      string\n    providers []types.Provider\n    config    *Config\n    counter   uint64\n}\n\ntype Config struct {\n    Strategy      Strategy `yaml:\"strategy\"`\n    ProviderNames []string `yaml:\"providers\"`\n}\n\ntype Strategy string\n\nconst (\n    StrategyRoundRobin Strategy = \"round_robin\"\n    StrategyRandom     Strategy = \"random\"\n    StrategyWeighted   Strategy = \"weighted\"\n)\n\nfunc NewLoadBalanceProvider(name string, config *Config) *LoadBalanceProvider {\n    return \u0026LoadBalanceProvider{\n        name:   name,\n        config: config,\n    }\n}\n\nfunc (lb *LoadBalanceProvider) SetProviders(providers []types.Provider) {\n    lb.providers = providers\n}\n\nfunc (lb *LoadBalanceProvider) Name() string              { return lb.name }\nfunc (lb *LoadBalanceProvider) Type() types.ProviderType { return \"loadbalance\" }\nfunc (lb *LoadBalanceProvider) Description() string      { return \"Distributes requests across providers\" }\n\nfunc (lb *LoadBalanceProvider) GenerateChatCompletion(ctx context.Context, opts types.GenerateOptions) (types.ChatCompletionStream, error) {\n    if len(lb.providers) == 0 {\n        return nil, fmt.Errorf(\"no providers configured\")\n    }\n\n    provider := lb.selectProvider()\n\n    chatProvider, ok := provider.(types.ChatProvider)\n    if !ok {\n        return nil, fmt.Errorf(\"selected provider does not support chat\")\n    }\n\n    return chatProvider.GenerateChatCompletion(ctx, opts)\n}\n\nfunc (lb *LoadBalanceProvider) selectProvider() types.Provider {\n    switch lb.config.Strategy {\n    case StrategyRandom:\n        return lb.providers[randomInt(len(lb.providers))]\n    default: // Round robin\n        idx := atomic.AddUint64(\u0026lb.counter, 1) - 1\n        return lb.providers[idx%uint64(len(lb.providers))]\n    }\n}\n\nfunc randomInt(max int) int {\n    // Simple random selection\n    return int(time.Now().UnixNano() % int64(max))\n}\n```\n\n**Acceptance Criteria:**\n- [ ] Load balance provider implements types.Provider\n- [ ] Round-robin strategy\n- [ ] Random strategy\n- [ ] Thread-safe counter\n- [ ] Unit tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:20.0608568Z","updated_at":"2025-11-29T02:16:10.988463856Z","closed_at":"2025-11-29T02:16:10.988463856Z","dependencies":[{"issue_id":"workspace-xzt","depends_on_id":"workspace-30d","type":"blocks","created_at":"2025-11-29T02:00:38.066228097Z","created_by":"daemon"}]}
{"id":"workspace-y4f","title":"Tests: pkg/providers/openai (80% coverage)","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:57:43.927376426Z","updated_at":"2025-11-29T10:35:45.487021913Z","closed_at":"2025-11-29T10:35:45.487021913Z"}
{"id":"workspace-yzb","title":"Remove unused cleanup.go utility","description":"## Summary\n\nThe `pkg/providers/common/cleanup.go` file contains `CleanCodeResponse()` which is no longer called anywhere after workspace-2ru removed its usage from providers.\n\n## Why Remove\n\n1. The function makes flawed assumptions (treats short lines as language identifiers)\n2. Any client needing code cleanup would implement custom logic for their use case\n3. Keeping unused utility code adds maintenance burden\n4. \"Maybe someone will use it\" is not a good reason to keep code\n\n## Files to Remove\n\n- `pkg/providers/common/cleanup.go`\n- `pkg/providers/common/cleanup_test.go`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T15:35:41.279599641Z","updated_at":"2025-11-29T15:38:31.798943016Z","closed_at":"2025-11-29T15:38:31.798943016Z"}
{"id":"workspace-zfs","title":"Remove aggressive model filtering that breaks OpenAI-compatible providers","description":"isChatModel() in OpenAI provider filters out all non-OpenAI models, breaking Groq and other compatible providers. Remove filter entirely and check other providers for similar issues.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-30T02:35:50.188400889Z","updated_at":"2025-11-30T02:38:55.146457904Z","closed_at":"2025-11-30T02:38:55.146457904Z"}
{"id":"workspace-zh8","title":"APK 4.1: Documentation","description":"#### Task 4.1: Documentation\n**Priority:** P1 - High\n**Estimated Effort:** 8 hours\n\n**Documentation to Create:**\n- [ ] Package documentation\n- [ ] API documentation\n- [ ] Extension development guide\n- [ ] Virtual provider configuration guide\n- [ ] Migration guide\n\n**Acceptance Criteria:**\n- [ ] Package documentation complete\n- [ ] API documentation complete\n- [ ] Extension development guide complete\n- [ ] Virtual provider configuration guide complete\n- [ ] Migration guide complete","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T01:59:58.965516167Z","updated_at":"2025-11-29T02:38:25.611920481Z","closed_at":"2025-11-29T02:38:25.611920481Z","dependencies":[{"issue_id":"workspace-zh8","depends_on_id":"workspace-sqx","type":"blocks","created_at":"2025-11-29T02:00:41.048178514Z","created_by":"daemon"},{"issue_id":"workspace-zh8","depends_on_id":"workspace-30w","type":"blocks","created_at":"2025-11-29T02:00:41.058054722Z","created_by":"daemon"}]}
{"id":"workspace-zu8","title":"Fix remaining duplicate code in server_test.go","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:11:44.622051802Z","updated_at":"2025-11-29T11:11:49.544889473Z","closed_at":"2025-11-29T11:11:49.544889473Z"}
